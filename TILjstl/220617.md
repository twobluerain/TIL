## [01] Category 테이블 모델링

### 1. 순환관계 모델링 하기

 \- 순환관계를 정의할때는 반드시 비식별관계로 정의 해야 한다. 
 \- 최초로 입력되는 최상의 코드의 FK에는 NULL값이 들어간다.
 \- 자식 엔티티로 전이되는 포린키 컬럼의 이름을 바꿔준다.

![image](https://user-images.githubusercontent.com/101780699/174030774-ab34a128-de33-4fa9-8dcf-cd00eed0a077.png)

### 2. 카테고리 및 상품 테이블 
(1) Workbench category Table에서 컬럼 추가하기

```sql
use webtest;

CREATE TABLE IF NOT EXISTS `webtest`.`category` (
  `cateno` INT NOT NULL AUTO_INCREMENT, -- 분류번호
  `catename` VARCHAR(50) NOT NULL,      -- 분류명
  `categrpno` INT NULL, -- 상위번호
  PRIMARY KEY (`cateno`),
  FOREIGN KEY (`categrpno`) REFERENCES category(`cateno`)
);
 
insert into category(catename, categrpno)
values('Jean', null);
insert into category(catename, categrpno)
values('Bag', null);
insert into category(catename, categrpno)
values('Shoes', null);
        
select cateno, catename
from category
where categrpno is null;

```



(2) Workbench contents 테이블에 컬럼 추가

![image](https://user-images.githubusercontent.com/101780699/174198861-b5dfd2f4-08e8-4fdf-979a-9920d457e804.png)

```sql
CREATE TABLE IF NOT EXISTS `webtest`.`contents` (
  `contentsno` INT NOT NULL AUTO_INCREMENT, -- 상품번호
  `cateno` INT NULL,                        -- 분류번호
  `pname` VARCHAR(50) NOT NULL,             -- 상품명
  `price` INT NOT NULL,                     -- 가격
  `filename` VARCHAR(100) NULL,             -- 상품이미지
  `detail` LONGTEXT NOT NULL,               -- 상세내용
  `rdate` DATE NOT NULL,                    -- 등록일
  `stock` INT NOT NULL DEFAULT 0,           -- 재고량
  PRIMARY KEY (`contentsno`),
  FOREIGN KEY (`cateno`) REFERENCES category (`cateno`)
 );
 
insert into contents(cateno, pname, price, filename, detail, rdate, stock)
values(1, 'Ripped Skinny Jeans', 
50000, 'jeans2.jpg','찢어진 스키니 청바지 입니다.',sysdate(),10);   

insert into contents(cateno, pname, price, filename, detail, rdate, stock)
values(1, '스키니 찢어진 청바지', 
40000, 'jeans1.jpg','슬립한 스키니를 입으면 날씬하고 예쁩니다. 여름에서 시원한 청바지로 맵시를 돋보일 수 있습니다.',sysdate(),10); 

insert into contents(cateno, pname, price, filename, detail, rdate, stock)
values(1, '옅은색 청바지', 
50000, 'jeans3.jpg','부드러운 촉감의 청바지 입니다. 색상이 옅은 청색으로 고급스럽게 코디하여 입을 수 있습니다.',sysdate(),10); 

insert into contents(cateno, pname, price, filename, detail, rdate, stock)
values(1, '기본형 청바지', 
30000, 'jeans4.jpg','기본형 청바지는 다양한 셔츠와 잘 어울립니다. 기본형 청바지로 편하게 코디하세요',sysdate(),10); 

insert into contents(cateno, pname, price, filename, detail, rdate, stock)
values(1, '찢어진 고급 청바지', 
50000, 'jeans4.jpg','고급 청바지는 외출시 맵시를 자랑할 수 있습니다. 어떠한 옷과도 잘 어울립니다.',sysdate(),10); 

insert into contents(cateno, pname, price, filename, detail, rdate, stock)
values(1, '스키니 청바지', 
40000, 'jeans1.jpg','스키니 청바지로 편하게 코디하세요, 외출시 가볍게 입을 수 있어 좋습니다.',sysdate(),10); 

insert into contents(cateno, pname, price, filename, detail, rdate, stock)
values(2, '명품 핸드백', 
50000, 'bag1.jpg','고풍스럽런 명품핸드백 너무 예쁩니다. 인기만점 핸드백을 겟 하세요',sysdate(),10); 

insert into contents(cateno, pname, price, filename, detail, rdate, stock)
values(2, '귀여운 숄더백', 
40000, 'bag2.jpg','캐쥬얼 복장과 잘 어울립니다. 귀엽고 예쁜 가방입니다.',sysdate(),10); 

insert into contents(cateno, pname, price, filename, detail, rdate, stock)
values(2, '미니 숄더백', 
40000, 'bag3.jpg','너무 귀엽고 사랑스러운 숄더백 입니다. 귀엽고 예쁜게 코디하세요.',sysdate(),10); 

insert into contents(cateno, pname, price, filename, detail, rdate, stock)
values(2, '고풍스런 복조리 가방', 
50000, 'bag4.jpg','토드백처럼 편하게 사용할 수 있습니다. 내용물이 많이 들어갑니다. 너무 예쁜 가방입니다.',sysdate(),10); 

insert into contents(cateno, pname, price, filename, detail, rdate, stock)
values(2, '멋장이 가방', 
60000, 'bag5.jpg','즐거운 여행에 멋내기 좋은 가방입니다. 멋진 여행동안 우화하게 코디하세요',sysdate(),10); 

insert into contents(cateno, pname, price, filename, detail, rdate, stock)
values(2, '라탄 가방', 
60000, 'bag6.png','인기만점 라탄 가방입니다. 여름에 예쁘게 코디하세요',sysdate(),10);

select contentsno, cateno, pname, price, filename, detail, stock 
from contents ;

update contents
set filename = 'bag6.png'
where contentsno = 12;

delete from contents
where contentsno = 1;
 
select contentsno, cateno,pname, price, filename, stock
from contents
order by contentsno desc
limit 0, 12;
```



### 3. ContentsDTO 구현

contents패키지 생성 후 ContentsDTO.java 생성

```java
package com.study.contents;
 
import org.springframework.web.multipart.MultipartFile;
import lombok.Data;
 
@Data
public class ContentsDTO {
 
  private int contentsno                  ;
  private int cateno                      ;
  private String pname                    ;
  private int price                       ;
  private String filename                 ;
  private MultipartFile filenameMF        ;
  private String detail                   ;
  private String rdate                    ;
  private int stock                       ;
}
```



---



## [01] Contents 기능 제작
### 1. mybatis xml, Mappper Interface

mybatis/contents.xml 생성

```xml
<?xml version="1.0" encoding="UTF-8" ?> 
 
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.study.contents.ContentsMapper">
        <update id="updateFile" parameterType="Map">
                update contents
                set filename = #{fname}
                where  contentsno = #{contentsno}
        </update>
 
        <select id="total" parameterType="Map" resultType="int">
                select count(*) from contents
                <where>
                        <choose>
                                <when test="col=='pname'">
                                        pname like concat('%', #{word} ,'%')
                                </when>
                                <when test="col=='price'">
                                        price like concat('%', #{word} ,'%')
                                </when>
                                <when test="col=='cateno'">
                                        cateno = #{word}
                                </when>
                        </choose>
                </where>
        </select>
 
        <select id="list" parameterType="Map"
                resultType="com.study.contents.ContentsDTO">
 
                select contentsno, cateno,pname, price, filename, stock,rdate
                from contents
                <where>
                <choose>
                        <when test="col=='pname'">
                                pname like concat('%', #{word} ,'%')
                        </when>
                        <when test="col=='price'">
                                price like concat('%', #{word} ,'%')
                        </when>
                        <when test="col=='cateno'">
                                cateno = #{word}
                        </when>
                </choose>
          </where>
       order by contentsno desc
       limit #{sno}, #{eno}
 
      </select>
 
 
        
        <update id="update" parameterType="com.study.contents.ContentsDTO">
            update contents
            set pname =#{pname},
                    price = #{price},
                    detail = #{detail}
            where contentsno =#{contentsno}
        </update>
        
        
        <insert id="create" parameterType="com.study.contents.ContentsDTO">
                insert into contents(cateno, pname, price, filename, detail, rdate, stock)
        values( #{cateno},#{pname}, #{price}, #{filename}, #{detail},
                sysdate(), #{stock})
        </insert>
        
</mapper>
 

```



contents/ContentsMapper.java 생성

```java
package com.study.contents;
 
import java.util.List;
import java.util.Map;
 
public interface ContentsMapper {
 
        int create(ContentsDTO dto);
 
        int update(ContentsDTO dto);
 
        int total(Map map);
 
        List<ContentsDTO> list(Map map);
 
        int updateFile(Map map);
        
}
```



### 2. Service Interface, impl Class 구현

contents/ContentsService.java

```java
package com.study.contents;
 
import java.util.List;
import java.util.Map;
 
public interface ContentsService {
 
int create(ContentsDTO dto);
 
int update(ContentsDTO dto);
 
int total(Map map);
 
List<ContentsDTO> list(Map map);
 
int updateFile(Map map);
 
}
```

contents/ContentsServiceImpl.java 생성

```java
package com.study.contents;
 
import java.util.List;
import java.util.Map;
 
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
@Service("com.study.contents.ContentsServiceImpl")
public class ContentsServiceImpl implements ContentsService {
  @Autowired
  private ContentsMapper mapper;
 
  @Override
  public int create(ContentsDTO dto) {
    // TODO Auto-generated method stub
    return mapper.create(dto);
  }
 
  @Override
  public int update(ContentsDTO dto) {
    // TODO Auto-generated method stub
    return mapper.update(dto);
  }
 
  @Override
  public int total(Map map) {
    // TODO Auto-generated method stub
    return mapper.total(map);
  }
 
  @Override
  public List<ContentsDTO> list(Map map) {
    // TODO Auto-generated method stub
    return mapper.list(map);
  }
 
  @Override
  public int updateFile(Map map) {
    // TODO Auto-generated method stub
    return mapper.updateFile(map);
  }
 
}
```



### 3. Controller Class 구현

ContentsController.java 생성

```java
package com.study.contents;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Controller;

@Controller
public class ContentsController {
        
  @Autowired
  @Qualifier("com.study.contents.ContentsServiceImpl")
  private ContentsService service;

  
}
```



UploadCon.java 생성

```java
package com.study.contents;
import java.io.File;
 
public class UploadCon {
    /** 페이지당 출력할 레코드 갯수 */
    public static int RECORD_PER_PAGE = 3;
 
    // Windows, VMWare, AWS cloud 절대 경로 설정
    public static synchronized String getUploadDir() {
        String path = "";
        if (File.separator.equals("\\")) {
            path = "C:/aistudy/deploy/contents/storage/";
            System.out.println("Windows 10: " + path);
            
        } else {
            // System.out.println("Linux");
            path = "/home/ubuntu/deploy/contents/storage/";
        }
        
        return path;
    }
    
}
```

폴더 생성

![image](https://user-images.githubusercontent.com/101780699/174200334-6b57af2d-8a54-4dba-b15f-35b5d238587f.png)

shop/WebMvcConfiguration/java 수정

```java
package com.study.shop;
 
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

import com.study.contents.UploadCon;
//import com.study.contents.*;
import com.study.member.UploadMem;
 
@Configuration
public class WebMvcConfiguration implements WebMvcConfigurer {
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        // Windows: path = "f:/AIstudy/deploy/shopping/contents/storage";
        // ▶ file:///f:/AIstudy/deploy/shopping/contents/storage
        // Ubuntu: path = "/home/ubuntu/deploy/shopping/contents/storage";
        // ▶ file:////home/ubuntu/deploy/shopping/contents/storage
        // JSP 인식되는 경로: http://localhost:8000/contents/storage";
        registry.addResourceHandler("/contents/storage/**")
        .addResourceLocations("file:///" + UploadCon.getUploadDir());
        registry.addResourceHandler("/member/storage/**")
        .addResourceLocations("file:///" + UploadMem.getUploadDir());
    }
 
}
```



### 4. View 페이지와 Tiles 
\- views/contents 폴더를 다운받은 후 위치에 복사한다.
\- TilesConfiguration.java 에서 tiles_contents.xml 추가

shop/TilesConfiguration.java 수정

```java
package com.study.shop;
 
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.view.tiles3.TilesConfigurer;
import org.springframework.web.servlet.view.tiles3.TilesView;
import org.springframework.web.servlet.view.tiles3.TilesViewResolver;
 
@Configuration
public class TilesConfiguration {
  @Bean
  public TilesConfigurer tilesConfigurer() {
      final TilesConfigurer configurer = new TilesConfigurer();
      //해당 경로에 tiles.xml 파일을 넣음
      configurer.setDefinitions(new String[]{"classpath:/templates/tiles_member.xml",
                                             "classpath:/templates/tiles_contents.xml"});
      configurer.setCheckRefresh(true);
      return configurer;
  }
 
  @Bean
  public TilesViewResolver tilesViewResolver() {
      final TilesViewResolver tilesViewResolver = new TilesViewResolver();
      tilesViewResolver.setViewClass(TilesView.class);
      return tilesViewResolver;
  }
}
```

resource/templates/tiles_contents.xml 생성

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE tiles-definitions PUBLIC
       "-//Apache Software Foundation//DTD Tiles Configuration 3.0//EN"
       "http://tiles.apache.org/dtds/tiles-config_3_0.dtd">
 
<tiles-definitions>
    <definition name="/contents/create" extends="main"> 
            <put-attribute name="title" value="상품등록" ></put-attribute> 
            <put-attribute name="body" value="/WEB-INF/views/contents/createForm.jsp" /> 
    </definition> 
    <definition name="/contents/list" extends="main"> 
            <put-attribute name="title" value="상품목록" ></put-attribute> 
            <put-attribute name="body" value="/WEB-INF/views/contents/list.jsp" /> 
    </definition> 
    <definition name="/contents/update" extends="main"> 
            <put-attribute name="title" value="상품수정" ></put-attribute> 
            <put-attribute name="body" value="/WEB-INF/views/contents/updateForm.jsp" /> 
    </definition> 
    <definition name="/contents/updateFile" extends="main"> 
            <put-attribute name="title" value="사진수정" ></put-attribute> 
            <put-attribute name="body" value="/WEB-INF/views/contents/updateFileForm.jsp" /> 
    </definition> 
</tiles-definitions>
```



### 5. top.jsp 
\- 관리자 메뉴에 상품목록을 추가한다.

top.jsp 수정

```jsp
<%@ page contentType="text/html; charset=UTF-8" %> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<c:set var="root" value="${pageContext.request.contextPath }"/>
 <c:choose>
    <c:when test="${not empty sessionScope.id && sessionScope.grade == 'A'}">
        <c:set var="str">관리자 페이지 입니다.</c:set>
    </c:when>
    <c:when test="${not empty sessionScope.id && sessionScope.grade != 'A'}">
        <c:set var='str'>안녕하세요  ${sessionScope.id } 님!</c:set>
    </c:when>
    <c:otherwise>
        <c:set var="str">기본 페이지 입니다.</c:set>
    </c:otherwise>
</c:choose>
<!DOCTYPE html> 
<html> 
<head>
  <title>memo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <style type="text/css">
  #grade{
  
   color :white;
  }  
  </style>
</head>
<body> 
<!--상단메뉴-->
<div class="container-fluid">
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="${root}/">Shop</a>
    </div>
    <ul class="nav navbar-nav">
      <li class="active"><a href="${root}/">Home</a></li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Product
        <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="#">Jean</a></li>
          <li><a href="#">Bag</a></li>
          <li><a href="#">Shoes</a></li>
        </ul>
      </li>
            <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">community
        <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="${root}/contents/mypage">Mypage</a></li>
          <li><a href="${root}/contents/detail">Review</a></li>
          <li><a href="/notice/list">Notice</a></li>
          <li><a href="#">Q&A</a></li>
        </ul>
      </li>
    <li><a id="grade"><span class="glyphicon glyphicon-grain"></span> ${str}</a></li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
     <c:choose>
    <c:when test="${empty sessionScope.id }">
      <li><a href="${root}/member/agree"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
      <li><a href="${root}/member/login"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
          </c:when>
              <c:when test="${not empty sessionScope.id && sessionScope.grade == 'A'}">
    <li><a href="${root}/admin/contents/create"><span class="glyphicon glyphicon-plus-sign"></span> 상품등록</a></li>
    <li><a href="${root}/contents/list"><span class="glyphicon glyphicon-list"></span> 상품목록</a></li>
    <li><a href="${root}/admin/member/list"><span class="glyphicon glyphicon-list"></span> 회원목록</a></li>
    <li><a href="${root}/admin/order/list"><span class="glyphicon glyphicon-list"></span> 주문목록</a></li>
    <li><a href="${root}/member/logout"><span class="glyphicon glyphicon-log-out"></span> 로그아웃</a></li>
    </c:when>
    <c:otherwise>
    <li><a href="${root}/cart/list"><span class="glyphicon glyphicon-shopping-cart"></span> Cart</a></li>
    <li><a href="${root}/member/update"><span class="glyphicon glyphicon-edit"></span> 회원수정</a></li>
    <li><a href="${root}/member/logout"><span class="glyphicon glyphicon-log-out"></span> 로그아웃</a></li>
        </c:otherwise>
    </c:choose> 
    
    </ul>
  </div>
</nav>
 
</div>
</body>
</html>
```

contents.zip 다운 후 

C:\aistudy\spring\workspace\shopping\src\main\webapp\WEB-INF\views\contents 경로에

`createForm.jsp` `list.jsp` `updateFileForm.jsp` `updateForm.jsp` 파일 붙여넣기

list.jsp 수정 86line 경로 수정

```jsp
<img src="/contents/storage/${dto.filename}"  class="img-rounded" width="100px" height="100px">
```

list.jsp 수정 58line 경로 수정

```jsp
    <button type="button" class="btn btn-default" 
    onclick="location.href='/admin/contents/create'">등록</button>
```



이미지 저장하기

![image](https://user-images.githubusercontent.com/101780699/174201374-1489ac27-49e6-4628-81f0-5d9aaa9ed120.png)

초기 셋팅 완료

![image](https://user-images.githubusercontent.com/101780699/174202142-1c947f27-d92c-4b70-918c-9686e8df5fa7.png)



---

---

## LIST

ContentsController.java 수정 list 추가

```java
@RequestMapping("/contents/list")
  public String list(HttpServletRequest request) {
          // 검색관련------------------------
          String col = Utility.checkNull(request.getParameter("col"));
          String word = Utility.checkNull(request.getParameter("word"));

          if (col.equals("total")) {
                  word = "";
          }

          // 페이지관련-----------------------
          int nowPage = 1;// 현재 보고있는 페이지
          if (request.getParameter("nowPage") != null) {
                  nowPage = Integer.parseInt(request.getParameter("nowPage"));
          }
          int recordPerPage = 5;// 한페이지당 보여줄 레코드갯수

          //(mysql) DB에서 가져올 순번-----------------
          int sno = (nowPage - 1) * recordPerPage;
          int eno = recordPerPage;

          Map map = new HashMap();
          map.put("col", col);
          map.put("word", word);
          map.put("sno", sno);
          map.put("eno", eno);

          int total = service.total(map);

          List<ContentsDTO> list = service.list(map);

          String paging = Utility.paging(total, nowPage, recordPerPage, col, word);

          // request에 Model사용 결과 담는다
          request.setAttribute("list", list);
          request.setAttribute("nowPage", nowPage);
          request.setAttribute("col", col);
          request.setAttribute("word", word);
          request.setAttribute("paging", paging);
          
          return "/contents/list";

  }
```

![image](https://user-images.githubusercontent.com/101780699/174202932-3a703103-7078-4067-882d-282365552514.png)

---

## CREATE & READ

ContentsController.java 수정 create 추가

```java
@PostMapping("/contents/create")
  public String create(ContentsDTO dto, HttpServletRequest request) throws IOException {
    String upDir = UploadCon.getUploadDir();

    String fname = Utility.saveFileSpring(dto.getFilenameMF(), upDir);
    int size = (int) dto.getFilenameMF().getSize();

    if (size > 0) {
      dto.setFilename(fname);
    } else {
      dto.setFilename("default.jpg");
    }

    if (service.create(dto) > 0) {
      return "redirect:./list";
    } else {
      return "error";
    }
  }

  @GetMapping("/admin/contents/create")
  public String create() {
    return "/contents/create";
  }
```

contents.xml 수정 read 추가

```xml
	<select id="read" parameterType="int"
		resultType="com.study.contents.ContentsDTO">
		select contentsno, cateno, pname, price, filename, detail,
		stock
		from contents
		where contentsno = ${contentsno};
	</select>
```

ContentsMapper.java 수정 read 추가

```java
ContentsDTO read(int contentsno);
```

ContentsService.java 수정 read 추가

```java
ContentsDTO read(int contentsno);
```

ContentsServiceImpl.java 수정 read 추가

```java
  @Override
  public ContentsDTO read(int contentsno) {
    // TODO Auto-generated method stub
    return mapper.read(contentsno);
  }
```

![image](https://user-images.githubusercontent.com/101780699/174220565-eab90067-5170-4665-83e9-db57a05c71a7.png)

---

## UPDATE

ContentsController.java 수정

```java
  @PostMapping("/contents/update")
  public String update(ContentsDTO dto) {
          int cnt = service.update(dto);
          
          if(cnt==1) {
                  return "redirect:./list";
          }else {
                  return "error";
          }
  }
  
  @GetMapping("/contents/update/{contentsno}")
  public String update(@PathVariable("contentsno") int contentsno, Model model) {
                          
          ContentsDTO dto = service.read(contentsno);
          
          model.addAttribute("dto",dto);
          
          return "/contents/update";
          
          
  }
```

![image](https://user-images.githubusercontent.com/101780699/174204849-79650f8e-1819-44fb-9a77-30e24b20726e.png)

![image](https://user-images.githubusercontent.com/101780699/174204860-14ad89ce-2a94-4f60-b34d-774c9a0d9441.png)

---

## UPDATEFILE

ContentsController.java 수정

```java
 @PostMapping("/contents/updateFile")
  public String updateFile(MultipartFile filenameMF,
                  String oldfile,int contentsno)throws IOException {
          String basePath = UploadCon.getUploadDir();
          
          if(oldfile !=null  && !oldfile.equals("default.jpg")) { //원본파일 삭제
                  Utility.deleteFile(basePath, oldfile);
          }
          
          //pstorage에 변경 파일 저장
          Map map = new HashMap();
          map.put("contentsno", contentsno);
          map.put("fname", Utility.saveFileSpring(filenameMF, basePath));
          
          //디비에 파일명 변경
          int cnt = service.updateFile(map);
          
          if(cnt==1) {
                  return "redirect:./list";
          }else {
                  return "./error";
          }
  }
        
        @GetMapping("/contents/updateFile/{contentsno}/{oldfile}")
        public String updateFileForm(@PathVariable("contentsno") int contentsno, 
                @PathVariable("oldfile") String oldfile, Model model) {
                model.addAttribute("contentsno",contentsno);
                model.addAttribute("oldfile",oldfile);
 
                return "/contents/updateFile";
        }
```

updateFileForm.jsp 수정 24line 경로수정

```java
        <img src="/contents/storage/${oldfile }" 
```





---

---





## [01] Ajax 사용하여 최상위 상품 메뉴등록

### 1.최상위 카테고리
\- 최상위 카테고리는 상위코드가 null인 값이다.
\- sql 문 작성



(1) mybatis contents.xml에 추가

contents.xml 수정 getCategory 추가

```xml
		<select id="getCategory" resultType="Map">
		select cateno, catename from category
		where categrpno is null
		</select>
```



(2) ContentsMapper 및 ContentsService interface에 추가

ContentsMapper.java 수정 getCategory 추가

```java
List<Map> getCategory();
```

ContentsService.java 수정 getCategory 추가

```java
List<Map> getCategory();
```



(3) ContentsServiceImpl 및 ContentsController 에 추가
\- ContentsController에서는 Ajax의 요청을 처리하는 코드이다. 
\- List<Map>의 결과가 JSON 형식으로 리턴된다.

ContentsServiceImpl.java 수정 getCategory 추가

```java
  @Override
  public List<Map> getCategory() {
    // TODO Auto-generated method stub
    return mapper.getCategory();
  }
```

ContentsController.java 수정 getCategory 추가

```java
  @GetMapping(value = "/contents/getCategory", produces = "application/json;charset=UTF-8")
  @ResponseBody
  public List<Map> getCategory(HttpServletRequest request) {
          List<Map> list = service.getCategory();
 
 
          return list;
  }
```



(4) top.jsp에서 jQuery Ajax사용
top.jsp 수정

```jsp
<%@ page contentType="text/html; charset=UTF-8" %> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<c:set var="root" value="${pageContext.request.contextPath }"/>
 <c:choose>
    <c:when test="${not empty sessionScope.id && sessionScope.grade == 'A'}">
        <c:set var="str">관리자 페이지 입니다.</c:set>
    </c:when>
    <c:when test="${not empty sessionScope.id && sessionScope.grade != 'A'}">
        <c:set var='str'>안녕하세요  ${sessionScope.id } 님!</c:set>
    </c:when>
    <c:otherwise>
        <c:set var="str">기본 페이지 입니다.</c:set>
    </c:otherwise>
</c:choose>
<!DOCTYPE html> 
<html> 
<head>
  <title>memo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <style type="text/css">
  #grade{
  
   color :white;
  }  
  </style>
  <script>
  $(function(){
      $.ajax({
          url: "/contents/getCategory",
          type: "GET",
          dataType: "json",
          success: function(data){
   
          for (var i = 0; i < data.length; i++) {
          $('#pmenu').append("<li><a href='/contents/mainlist/"+data[i].cateno+"'>" + data[i].catename + "</a></li>");
                     }                  

          },
          error: function(request,status,error){
             alert("code = "+ request.status + " message = " + request.responseText + " error = " + error); // 실패 시 처리
          }                
      });//ajax end
});//페이지로딩
  </script>
</head>
<body> 
<!--상단메뉴-->
<div class="container-fluid">
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="${root}/">Shop</a>
    </div>
    <ul class="nav navbar-nav">
      <li class="active"><a href="${root}/">Home</a></li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Product
        <span class="caret"></span></a>
        <ul class="dropdown-menu" id="pmenu">
        </ul>
      </li>
            <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">community
        <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="${root}/contents/mypage">Mypage</a></li>
          <li><a href="${root}/contents/detail">Review</a></li>
          <li><a href="/notice/list">Notice</a></li>
          <li><a href="#">Q&A</a></li>
        </ul>
      </li>
    <li><a id="grade"><span class="glyphicon glyphicon-grain"></span> ${str}</a></li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
     <c:choose>
    <c:when test="${empty sessionScope.id }">
      <li><a href="${root}/member/agree"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
      <li><a href="${root}/member/login"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
          </c:when>
              <c:when test="${not empty sessionScope.id && sessionScope.grade == 'A'}">
    <li><a href="${root}/admin/contents/create"><span class="glyphicon glyphicon-plus-sign"></span> 상품등록</a></li>
    <li><a href="${root}/contents/list"><span class="glyphicon glyphicon-list"></span> 상품목록</a></li>
    <li><a href="${root}/admin/member/list"><span class="glyphicon glyphicon-list"></span> 회원목록</a></li>
    <li><a href="${root}/admin/order/list"><span class="glyphicon glyphicon-list"></span> 주문목록</a></li>
    <li><a href="${root}/member/logout"><span class="glyphicon glyphicon-log-out"></span> 로그아웃</a></li>
    </c:when>
    <c:otherwise>
    <li><a href="${root}/cart/list"><span class="glyphicon glyphicon-shopping-cart"></span> Cart</a></li>
    <li><a href="${root}/member/update"><span class="glyphicon glyphicon-edit"></span> 회원수정</a></li>
    <li><a href="${root}/member/logout"><span class="glyphicon glyphicon-log-out"></span> 로그아웃</a></li>
        </c:otherwise>
    </c:choose> 
    
    </ul>
  </div>
</nav>
 
</div>
</body>
</html>
```

![image](https://user-images.githubusercontent.com/101780699/174211971-8927ae4c-9709-43db-ba02-b96e0f7333d9.png)



---



## [01] 상품구매를 위한 상품목록 만들기
\- 메인페이지에서 최상위 카테고리 메뉴를 선택하여 상품목록를 출력한다.

### 1. 상품목록 출력



(1) mybatis contents.xml

contents.xml 수정 mainlist 추가

```xml
<select id="mainlist" parameterType="map" resultType="com.study.contents.ContentsDTO">
         select contentsno, cateno,pname, price, filename, stock
         from contents
                 
         <where>
         <choose>
             <when test="col=='pname'">
                 pname like concat('%', #{word} ,'%')
             </when>
             <when test="col=='price'">
                 price like concat('%', #{word} ,'%')
             </when>
         </choose>
          and cateno = #{cateno}
         </where>
         order by contentsno desc
         limit #{sno}, #{eno}
    	</select>
```



(2) ContentsMapper 및 ContentsService

ContentsMapper.java 수정 mainlist 추가

```java
List<ContentsDTO> mainlist(Map map);
```

ContentsService.java 수정 mainlist 추가

```java
  List<ContentsDTO> mainlist(Map map);
```



(3) ContentsServiceImpl 및 ContentsController, Utility

ContentsServiceImpl.java 수정 mainlist 추가

```java
  @Override
  public List<ContentsDTO> mainlist(Map map) {
    // TODO Auto-generated method stub
    return mapper.mainlist(map);
  }
```

ContentsController.java 수정 mainlist 추가

```java
@Override
  public List<ContentsDTO> mainlist(Map map) {
    // TODO Auto-generated method stub
    return mapper.mainlist(map);
  }
............

>>> ContentsController.java

..............
@GetMapping("/contents/mainlist/{cateno}")
  public String mainlist(@PathVariable("cateno") int cateno, HttpServletRequest request, Model model) {
 // 검색관련------------------------
    String col = Utility.checkNull(request.getParameter("col"));
    String word = Utility.checkNull(request.getParameter("word"));
 
    if (col.equals("total")) {
      word = "";
    }
 
    // 페이지관련-----------------------
    int nowPage = 1;// 현재 보고있는 페이지
    if (request.getParameter("nowPage") != null) {
      nowPage = Integer.parseInt(request.getParameter("nowPage"));
    }
    int recordPerPage = 8;// 한페이지당 보여줄 레코드갯수
 
    //(Oracle) DB에서 가져올 순번-----------------
    //int sno = ((nowPage - 1) * recordPerPage) + 1;
    //int eno = nowPage * recordPerPage;

    //(MySQL) DB에서 가져올 순번-----------------
    int sno = (nowPage - 1) * recordPerPage;
    int eno = recordPerPage;
 
    Map map = new HashMap();
    map.put("col", "cateno");
    map.put("word", cateno);
 
    int total = service.total(map);
    
    map = new HashMap();
    map.put("col", col);
    map.put("word", word);
    map.put("sno", sno);
    map.put("eno", eno);
    map.put("cateno", cateno);
 
    List<ContentsDTO> list = service.mainlist(map);
 
    String paging = Utility.paging2(total, nowPage, recordPerPage, col, word,cateno);
 
    // request에 Model사용 결과 담는다
    request.setAttribute("list", list);
    request.setAttribute("nowPage", nowPage);
    request.setAttribute("col", col);
    request.setAttribute("word", word);
    request.setAttribute("paging", paging);
    request.setAttribute("cateno", cateno);
    
    return "/contents/mainlist";
 
  }
```

Utility.java 수정 paging2 추가

```java
public static String paging2(int total, int nowPage, int recordPerPage, String col, String word, int cateno) {
    int pagePerBlock = 5; // 블럭당 페이지 수
    int totalPage = (int) (Math.ceil((double) total / recordPerPage)); // 전체 페이지
    int totalGrp = (int) (Math.ceil((double) totalPage / pagePerBlock));// 전체 그룹
    int nowGrp = (int) (Math.ceil((double) nowPage / pagePerBlock)); // 현재 그룹
    int startPage = ((nowGrp - 1) * pagePerBlock) + 1; // 특정 그룹의 페이지 목록 시작
    int endPage = (nowGrp * pagePerBlock); // 특정 그룹의 페이지 목록 종료
 
    StringBuffer str = new StringBuffer();
    str.append("<div style='text-align:center'>");
    str.append("<ul class='pagination'> ");
    int _nowPage = (nowGrp - 1) * pagePerBlock; // 10개 이전 페이지로 이동
    if (nowGrp >= 2) {
      str.append("<li><a href='/contents/mainlist/"+cateno+"?col=" + col + "&word=" + word + "&nowPage=" + _nowPage + "'>이전</A></li>");
    }
 
    for (int i = startPage; i <= endPage; i++) {
      if (i > totalPage) {
        break;
      }
 
      if (nowPage == i) {
        str.append("<li class='active'><a href=#>" + i + "</a></li>");
      } else {
        str.append(
            "<li><a href='/contents/mainlist/"+cateno+"?col=" + col + "&word=" + word + "&nowPage=" + i + "'>" + i + "</A></li>");
      }
    }
 
    _nowPage = (nowGrp * pagePerBlock) + 1; // 10개 다음 페이지로 이동
    if (nowGrp < totalGrp) {
      str.append("<li><A href='/contents/mainlist/"+cateno+"?col=" + col + "&word=" + word + "&nowPage=" + _nowPage + "'>다음</A></li>");
    }
    str.append("</ul>");
    str.append("</div>");
 
    return str.toString();
  }
```



(5) view 및 tiles

index.jsp 수정

```jsp
<%@ page contentType="text/html; charset=UTF-8" %> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
 
<!DOCTYPE html> 
<html> 
<head>
  <title>기본페이지</title>
  <meta charset="utf-8">
<style type="text/css">
    
img {
  display:inline;
 
}
 
</style>
</head>
<body> 
 
<div class="container">
    <p><a href="/content/mainlist" >SHOP NOW</a></p>
    <img src="/images/pepe.jpg" alt="Jeans">
    
</div>
</body> 
</html>
```

contents/mainlist.jsp 생성

```jsp
<%@ page contentType="text/html; charset=UTF-8" %> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html> 
<html> 
<head>
  <title>상품메인페이지</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body> 
 
<div class="container">
<h3> new Item </h3>
<c:choose>   
<c:when test="${empty list}">
   <div class="row">
   <h2>상품 준비중 입니다.</h2> 
   <p><img src="/contents/storage/default.jpg" class="img-thumbnail"  width="236" height="306"></p>
   
   </div>
</c:when>
<c:otherwise>
<c:set var="list" value="${list}"/>
<div class="row">
    <c:forEach var="dto" begin="0" end="3" items="${list}">
    <div class="col-sm-3">
      <c:choose>
      <c:when test="${cateno==1 }">
      <h3>Ripped Skinny</h3>
      </c:when>
      <c:when test="${cateno==2 }">
      <h3>Luxury BAG</h3>
      </c:when>
      </c:choose>
      <p>
      <a href="/contents/detail/${dto.contentsno }">
       <img src="/contents/storage/${dto.filename }" class="img-thumbnail"  width="236" height="306"></a></p>
        <p> ${dto.pname }<br> <b>가격 :  ${dto.price }</b> </p>
        <div> 
         <a href="/contents/detail/${dto.contentsno }""><img class='btn'src="/svg/cart4.svg"/></a>
         <a href="/contents/detail/${dto.contentsno }""><img class='btn' src="/svg/bag-heart-fill.svg"/></a>
        </div>
 
    </div>
    </c:forEach>
</div>
 <div class="row">
    <c:forEach var="dto" begin="4" end="7" items="${list}">
    <div class="col-sm-3">
      <c:choose>
      <c:when test="${cateno==1 }">
      <h3>Vintage Skinny</h3>
      </c:when>
      <c:when test="${cateno==2 }">
      <h3>Classy BAG</h3>
      </c:when>
      </c:choose>
      <p>
       <a href="/contents/detail/${dto.contentsno }">
        <img src="/contents/storage/${dto.filename }" class="img-thumbnail"  width="236" height="306"></a></p>
        <p> ${dto.pname }<br> <b>가격 : ${dto.price }</b> </p>
        <div> 
         <a href="/contents/detail/${dto.contentsno }"><img class='btn'src="/svg/cart4.svg"/></a>
         <a href="/contents/detail/${dto.contentsno }"><img class='btn' src="/svg/bag-heart-fill.svg"/></a>
        </div>
    </div>
    </c:forEach>
</div>
  ${paging}
</c:otherwise>
</c:choose>
</div>
</body> 
</html> 
```

title_contents.xml 수정 mainlist 추가

```xml
    <definition name="/contents/mainlist" extends="main"> 
            <put-attribute name="title" value="상품메인목록" ></put-attribute> 
            <put-attribute name="body" value="/WEB-INF/views/contents/mainlist.jsp" /> 
    </definition> 
```

![image](https://user-images.githubusercontent.com/101780699/174214811-c251418c-0089-483c-85dd-777f8cf50cd7.png)

![image](https://user-images.githubusercontent.com/101780699/174214461-1e2373ff-734d-45d3-818a-62372e1589f0.png)

![image](https://user-images.githubusercontent.com/101780699/174214869-43997c7c-fec3-42ab-807e-c1cd93512ce5.png)

![image](https://user-images.githubusercontent.com/101780699/174214493-c686fec3-6003-40f4-ba82-6210e963be2d.png)





---





## [01] 상품상세 페이지 제작

\- 상품목록에서 상품이미지를 클릭하여 상품상세페이지로 이동한다.



### 1. 상품상세 페이지 

(1) mybatis contents.xml 수정 detail 추가

```xml
    <select id="detail" parameterType="int" resultType="com.study.contents.ContentsDTO">
    
        select contentsno, cateno, pname, price, filename, stock, detail
        from contents
        where contentsno = #{conentsno}
    </select>
```



(2) ContentsMapper 및 ContentsService

ContentsMapper.java 수정 detail 추가

```java
ContentsDTO detail(int contentsno);
```

ContentsService.java 수정 detail 추가

```java
 ContentsDTO detail(int contentsno);
```



(3) ContentsServiceImpl 및 ContentsController

ContentsServiceImpl.java 수정 detail 추가

```java
  @Override
  public ContentsDTO detail(int contentsno) {
    // TODO Auto-generated method stub
    return mapper.detail(contentsno);
  }
```

ContentsController.java 수정 detail 추가

```java
@GetMapping("/contents/detail/{contentsno}")
public String detail(@PathVariable("contentsno") int contentsno, Model model) {
    
   model.addAttribute("dto",service.detail(contentsno));
  
    return "/contents/detail";
}
```



(4) view 및 tiles

detail.jsp 생성

```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
 
<div class="container">
  <div class="row">
  <div class="col-sm-3">
  <h4><img src="/svg/box2-heart.svg"> 상품 정보</h4>
  <img class="img-rounded" src="/contents/storage/${dto.filename}" style="width:250px">
  <div class="caption">
    <p>상품명:${dto.pname}</p>
    <p>${dto.detail }</p>
  </div>
  </div>
  <div class="col-sm-6">
  <h4><img src="/svg/rulers.svg"> 사이즈 및 수량</h4>
  <ul class="list-group">
    <li class="list-group-item">사이즈 :
     <select class="form-select" aria-label="Default select example">
  <option selected>사이즈 선택</option>
  <option value="1">L</option>
  <option value="2">M</option>
  <option value="3">S</option>
</select>
    <li class="list-group-item">가격 : ${dto.price }
    <li class="list-group-item">재고 : ${dto.stock }
    <li class="list-group-item">수량 : <input type="number" name="quantity" min=0 max=20 value="1" >     
    <li class="list-group-item"><img class='btn' src="${request.ContextPath }/svg/cart4.svg"/>
         <img class='btn' src="${request.ContextPath }/svg/bag-heart-fill.svg"/> 
         <a href="javascript:history.back()"><img class='btn' src="${request.ContextPath }/svg/arrow-return-left.svg"/></a>
 
  </ul>
  </div>
  </div>
</div>
 
</body>
</html>
```

titles_contents.xml 수정 detail 추가

```xml
    <definition name="/contents/detail" extends="main"> 
            <put-attribute name="title" value="상품상세페이지" ></put-attribute> 
            <put-attribute name="body" value="/WEB-INF/views/contents/detail.jsp" /> 
    </definition>
```

![image](https://user-images.githubusercontent.com/101780699/174225314-adfed397-e589-4cf9-ac5d-4422cbdfa4b7.png)



---



detail.jsp 수정 버튼에 링크 수정

```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
 
<div class="container">
  <div class="row">
  <div class="col-sm-3">
  <h4><img src="/svg/box2-heart.svg"> 상품 정보</h4>
  <img class="img-rounded" src="/contents/storage/${dto.filename}" style="width:250px">
  <div class="caption">
    <p>상품명:${dto.pname}</p>
    <p>${dto.detail }</p>
  </div>
  </div>
  <div class="col-sm-6">
  <h4><img src="/svg/rulers.svg"> 사이즈 및 수량</h4>
  <ul class="list-group">
    <li class="list-group-item">사이즈 :
    <c:choose>
    <c:when test="${dto.cateno==1}">
     <select class="form-select" aria-label="Default select example">
  		<option selected>사이즈 선택</option>
	  	<option value="1">L</option>
  		<option value="2">M</option>
  		<option value="3">S</option>
  		</select>
    </c:when>
    <c:when test="${dto.cateno==2}">
        <select class="form-select" aria-label="Default select example" disabled="disabled">
  		<option selected>사이즈 선택</option>
  		</select>
    </c:when>
    <c:when test="${dto.cateno==3}">
        <select class="form-select" aria-label="Default select example" >
  		<option selected>사이즈 선택</option>
	  	<option value="220">220</option>
  		<option value="230">230</option>
  		<option value="240">240</option>
  		<option value="250">250</option>
  		<option value="260">260</option>
  		<option value="270">270</option>
  		<option value="280">280</option>
  		<option value="290">290</option>
  		</select>
    </c:when>
    </c:choose>
    <li class="list-group-item">가격 : ${dto.price }
    <li class="list-group-item">재고 : ${dto.stock }
    <li class="list-group-item">수량 : <input type="number" name="quantity" min=0 max=20 value="1" >     
    <li class="list-group-item">
    	 <a href="javascript:cart()">
   		 <img class='btn' src="/svg/cart4.svg"/></a>
    	 <a href="javascript:cart()">
         <img class='btn' src="/svg/bag-heart-fill.svg"/></a>
         <a href="javascript:history.back()">
         <img class='btn' src="/svg/arrow-return-left.svg"/></a>
 
  </ul>
  </div>
  </div>
</div>
 
</body>
</html>
```





---



## [01] mypage 구현
\- 회원의 구매이력과 배송정보를 확인할 수 있다.
\- 회원테이블과 구매테이블의 left outer join를 해야 구매이력이 없는
 회원의 정보도 가져올 수 있다.



### 1. sql 및 mybatis

(1) orders 테이블 생성 및 insert 구문

order.sql 저장

```sql
use webtest;
drop table order_detail  ;
drop table orders  ;
/**********************************/
/* Table Name: 주문 */
/**********************************/
CREATE TABLE orders(
orderno                      int    NOT NULL  PRIMARY KEY auto_increment,  -- 주문번호
id                           VARCHAR(10)  NOT NULL,                      -- 아이디(F)
mname                     VARCHAR(20)  NOT NULL,                      -- 주문자 이름
odate                        DATE         NOT NULL,                     -- 주문날짜
ostate                       VARCHAR(50) default '배송준비중' NOT NULL ,                     -- 주문상태
total                        int  NOT NULL,                     -- 총합금액
payment                   VARCHAR(50)  NOT NULL,             -- 결제정보
reqtext                      varchar(50)  not null,             -- 요청메세지
 
  FOREIGN KEY (id) REFERENCES member(id)
);
 
 
/**********************************/
/* Table Name: 주문 상세 */
/**********************************/
CREATE TABLE order_detail(
odno                         int  NOT NULL  PRIMARY KEY auto_increment, -- 주문상세번호
orderno                      int  NOT NULL,                     -- 주문번호(F)     
contentsno                   int  NULL ,                        -- 상품번호(F)
quantity                     int  NOT NULL,                     -- 수량
pname                        VARCHAR(50)  NOT NULL,             -- 상품이름
  FOREIGN KEY (contentsno) REFERENCES contents (contentsno),
  FOREIGN KEY (orderno) REFERENCES orders (orderno)
);
 
-- 주문1
insert into orders(id, mname, odate , total, payment,reqtext)
values('user1','개발자1',sysdate(), 153000,'신용카드', '문앞에 놓아주세요');
 
select * from orders;
 
insert into order_detail(
orderno , contentsno, quantity,  pname )
values(1,1,2,'Mega Ripped Jeans');
 
insert into order_detail(
orderno,  contentsno,  quantity,  pname)
values(1,1,1,'Crocodile bag');
 
-- 주문 2
-- SELECT DATE_ADD(sysdate(), INTERVAL 1 DAY); 
insert into orders(id, mname, odate, total, payment,reqtext)
values('user1','개발자1',DATE_ADD(sysdate(), INTERVAL 1 DAY)
,153000,'신용카드','문앞에 놓아주세요');
 
select * from orders;
 
insert into order_detail(
orderno , contentsno, quantity,   pname)
values(2,1,2,'Mega Ripped Jeans');
 
insert into order_detail(
orderno,  contentsno,  quantity,  pname)
values(2,1,1,'Crocodile bag');
 
select * from order_detail;
```



(2) 3개 테이블의 조인문 작성

```sql
-- 3개 테이블의 조인문 작성
 
select  m.id, m.mname, m.fname, m.zipcode, m.address1, m.address2,
         o.orderno,o.odate,o.total,o.ostate,o.reqtext, d.quantity,d.contentsno,d.pname
 from  member m left outer join orders o
    on  m.id = o.id left outer join order_detail d
    on  o.orderno = d.orderno
where  m.id='user1';
```

![image](https://user-images.githubusercontent.com/101780699/174232172-d05c246b-99f7-4531-8279-f474408060e0.png)

(3) mybatis member.xml 작성
\- 1:n 관계의 join 생성를 하고 결과를 담을 수있는 resultMap를 사용한다.

member.xml 수정 orders추가

```xml
 <resultMap type="com.study.member.MemberDTO" id="memberOrder">
                <result property="id" column="id" />
                <result property="mname" column="mname" />
                <result property="fname" column="fname" />
                <result property="zipcode" column="zipcode" />
                <result property="address1" column="address1" />
                <result property="address2" column="address2" />
                <collection property="list" column="id" javaType="List"
                        ofType="com.study.orders.OdersDTO" resultMap="orderList" />
        </resultMap>
        <resultMap type="com.study.orders.OrdersDTO" id="orderList">
                <result property="orderno" column="orderno" />
                <result property="odate" column="odate" />
                <result property="total" column="total" />
                <result property="ostate" column="ostate" />
                <collection property="list" column="id" javaType="List"
                        ofType="com.study.orders.OderdetailDTO" resultMap="detailList" />
        </resultMap>    
        <resultMap type="com.study.orders.OrderdetailDTO" id="detailList">
            <result property="quantity" column="quantity"/>
                <result property="pname" column="pname" />
                <result property="contentsno" column="contentsno" />            
        </resultMap>
        <select id="mypage" parameterType="String"
                resultMap="memberOrder">
                select  m.id, m.mname, m.fname, m.zipcode, m.address1, m.address2,
         o.orderno,o.odate,o.total,o.ostate,o.reqtext, d.quantity,
         d.contentsno, d.pname
                from  member m left outer join orders o
                on  m.id = o.id left outer join order_detail d
                on  o.orderno = d.orderno
                where  m.id=#{id}
        </select>
```



(4) MemerDTO 변경
\- 부모테이블 MemberDTO에 자식테이블 내용을 담을 List<OrdersDTO> 필드를 선언한다.
\- 1:n일 경우에만 사용한다 그외 조인은 JoinDTO(MemberDTO + OrdersDTO) 사용

MemberDTO.java 수정 odersDTO 추가

```java
    private List<OrdersDTO> list;
```

oders/OrdersDTO.java 생성

```java
package com.study.orders;
 
import java.util.List;
 
import lombok.Data;
 
@Data
public class OrdersDTO {
  private int   orderno              ;
  private String id                  ;
  private String mname               ;
  private String odate               ;
  private String ostate              ;
  private int    total                ;
  private String payment             ;
  private String reqtext             ;
 
  private List<OrderdetailDTO> list  ;
}
```

orders/OrderdetailDTO.java 생성

```java
package com.study.orders;
 
import lombok.Data;
 
@Data
public class OrderdetailDTO {
 
private int    odno                 ;
private int    orderno                ;
private int    contentsno             ;
private int    quantity             ;
private String pname               ;
}
```



(5) MemberMapper, MemberService

MemberMapper.java 수정 mypage 추가

```java
MemberDTO mypage(String id);
```

MemberService.java 수정 mypage 추가

```java
MemberDTO mypage(String id);
```



(6) MemberServiceImpl, MemberController

MemberServiceImpl.java mypage 추가

```java
       @Override
        public MemberDTO mypage(String id) {
          // TODO Auto-generated method stub
          return mapper.mypage(id);
        }
```

MemberController.java 수정 mypage 추가

```java
@GetMapping("/member/mypage")
public String mypage(HttpSession session, Model model) {
   String id = (String)session.getAttribute("id");
 
  if(id==null) {
       return "redirect: ./login/";
  }else {
  
       MemberDTO dto = service.mypage(id);
      
       model.addAttribute("dto", dto);
      
   return "/member/mypage";
  }
}
```

top.jsp 수정

```jsp
<%@ page contentType="text/html; charset=UTF-8" %> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<c:set var="root" value="${pageContext.request.contextPath }"/>
 <c:choose>
    <c:when test="${not empty sessionScope.id && sessionScope.grade == 'A'}">
        <c:set var="str">관리자 페이지 입니다.</c:set>
    </c:when>
    <c:when test="${not empty sessionScope.id && sessionScope.grade != 'A'}">
        <c:set var='str'>안녕하세요  ${sessionScope.id } 님!</c:set>
    </c:when>
    <c:otherwise>
        <c:set var="str">기본 페이지 입니다.</c:set>
    </c:otherwise>
</c:choose>
<!DOCTYPE html> 
<html> 
<head>
  <title>memo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <style type="text/css">
  #grade{
  
   color :white;
  }  
  </style>
  <script>
  $(function(){
      $.ajax({
          url: "/contents/getCategory",
          type: "GET",
          dataType: "json",
          success: function(data){
   
          for (var i = 0; i < data.length; i++) {
          $('#pmenu').append("<li><a href='/contents/mainlist/"+data[i].cateno+"'>" + data[i].catename + "</a></li>");
                     }                  

          },
          error: function(request,status,error){
             alert("code = "+ request.status + " message = " + request.responseText + " error = " + error); // 실패 시 처리
          }                
      });//ajax end
});//페이지로딩
  </script>
</head>
<body> 
<!--상단메뉴-->
<div class="container-fluid">
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="${root}/">Shop</a>
    </div>
    <ul class="nav navbar-nav">
      <li class="active"><a href="${root}/">Home</a></li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Product
        <span class="caret"></span></a>
        <ul class="dropdown-menu" id="pmenu">
        </ul>
      </li>
            <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">community
        <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="${root}/member/mypage">Mypage</a></li>
          <li><a href="${root}/contents/detail">Review</a></li>
          <li><a href="/notice/list">Notice</a></li>
          <li><a href="#">Q&A</a></li>
        </ul>
      </li>
    <li><a id="grade"><span class="glyphicon glyphicon-grain"></span> ${str}</a></li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
     <c:choose>
    <c:when test="${empty sessionScope.id }">
      <li><a href="${root}/member/agree"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
      <li><a href="${root}/member/login"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
          </c:when>
              <c:when test="${not empty sessionScope.id && sessionScope.grade == 'A'}">
    <li><a href="${root}/admin/contents/create"><span class="glyphicon glyphicon-plus-sign"></span> 상품등록</a></li>
    <li><a href="${root}/contents/list"><span class="glyphicon glyphicon-list"></span> 상품목록</a></li>
    <li><a href="${root}/admin/member/list"><span class="glyphicon glyphicon-list"></span> 회원목록</a></li>
    <li><a href="${root}/admin/order/list"><span class="glyphicon glyphicon-list"></span> 주문목록</a></li>
    <li><a href="${root}/member/logout"><span class="glyphicon glyphicon-log-out"></span> 로그아웃</a></li>
    </c:when>
    <c:otherwise>
    <li><a href="${root}/cart/list"><span class="glyphicon glyphicon-shopping-cart"></span> Cart</a></li>
    <li><a href="${root}/member/update"><span class="glyphicon glyphicon-edit"></span> 회원수정</a></li>
    <li><a href="${root}/member/logout"><span class="glyphicon glyphicon-log-out"></span> 로그아웃</a></li>
        </c:otherwise>
    </c:choose> 
    
    </ul>
  </div>
</nav>
 
</div>
</body>
</html>
```



(7) views 와 tiles

views/member/mypage.jsp 생성

```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
</head>
<body>
 
<div class="container">
  <div class="row">
  <div class="col-sm-3">
  <h3><span class="glyphicon glyphicon-user"></span> 나의 정보</h3>
  <img class="img-rounded" src="/member/storage/${dto.fname}" style="width:280px">${dto.fname}
  <div class="caption">
    <p>ID:${dto.id}, 성명:${dto.mname}</p>
    <p>배송지:(${dto.zipcode })${dto.address1 }  ${dto.address2}</p>
  </div>
  </div>
  <div class="col-sm-6">
  <h3><span class="glyphicon glyphicon-gift"></span> 주문 내역 및 리뷰 작성</h3>
  <ul class="list-group">
   <c:choose>
    <c:when test="${empty dto.list }">주문한 상품이 없습니다.</c:when>
    
    <c:otherwise>
    <c:forEach var="order" items="${dto.list}" >
    <p class='h4'>${fn:substring(order.odate,0,10)}<p>
       <li class="list-group-item">결제금액 : ${order.total} 원, 주문상태 : ${order.ostate}
    <c:forEach var="detail" items="${order.list}">
    <li class="list-group-item">${detail.pname}, ${detail.quantity}개
     <a href="review/create/${detail.contentsno}"><span class="badge">Rivew</span></a></li>
    </c:forEach>
</c:forEach>
    </c:otherwise>
    </c:choose>
  </ul>
  </div>
  </div>
</div>
 
</body>
</html>
```

tiles_member.xml 수정 mypage 추가

```xml
  <definition name="/member/mypage" extends="main">
    <put-attribute name="title" value="나의페이지"></put-attribute>
    <put-attribute name="body"
      value="/WEB-INF/views/member/mypage.jsp" />
  </definition>
```

![image](https://user-images.githubusercontent.com/101780699/174235077-667f53ac-63c3-45ac-ab2a-7c041da376da.png)



---



## [01] AOP(Aspect Oriented Programming)의 구현 

\- Spring_bbs 프로젝트에서 작업

### 1. 관점 지향 프로그래밍(AOP : Aspect-Oriented Programming)
 \- 트랜잭션이나 로깅, 보안과 같이 여러 모듈에서 공통적으로 사용하는 기능의  경우 해당 기능을 분리하여 관리할 수 있다.
 \- 공통모듈의 반복적인 코드를 줄이고, 핵심 비즈니스 로직에만 집중할 수 있는 방법을 제공한다.
 \- 핵심관심(core concern) : 핵심 비즈니스 기능
 \- 공통관심(cross-cutting concern) : 횡단관심이라고도 하며, 어플리케이션 전반에 걸쳐 적용되는 공통 기능 (부가기능)

 \- 은행 업무에서 계좌이체, 이자계산, 대출처리는 주된업무로 핵심관점이다.
 \- 이 업무를 처리할때 '로깅', '보안', '트랜잭션' 등의 처리는 어플리케이션 전반에 걸처 필요한 기능인 공통(횡단)관심(Cross-Cutting Concern)이다.
 \- AOP에서는 공통관심을 하나의 클래스 단위(aspect)분리하여 재사용성과 유지보수성을 높인다.
 \- AOP를 적용할 경우 핵심로직을 구현한 클래스는 더 이상 여러 공통모듈을 의존하지 않는다
 \- 핵심로직 구현클래스에서 공통모듈을 사용하는 코드를 포함하지 않는다.



### 2. AOP 주요 용어

![image](https://user-images.githubusercontent.com/101780699/174241973-acc1c3c3-b3d5-4b45-8c1c-01d80342b1ca.png)

(1) 조인포인트(Joinpoint)
 \- 조인포인트는 클라이언트가 호출하는 모든 비즈니스 메소드로서, BbsService, MemberService 클래스의 모든 메소드를 말한다.
 \- 포인트컷 대상, 포인트컷 후보라고 하며, 조인포인트 중에서 포인트컷이 선택된다.

(2) 포인트컷(Pointcut)
 \- 클라이언트가 호출하는 모든 비즈니스 메소드가 조인포인트라면, 포인트컷은 필터링된 조인포인트를 의미한다.
 \- 트랜잭션처리 하는 공통기능을 만들었을때, 횡단관심은 등록, 수정, 삭제 기능의 비즈니스 메소드에 대해서는 동작을 하고 검색 기능의 메소드에서는 트랜잭션과 무관하여 동작할 필요가 없다.
 \- 수많은 비즈니스 메소드 중에서 우리가 원하는 특정 메소드에서만 횡단관심에 해당하는 공통기능을 수행시키기 위해서 포인트컷이 필요하다.
 \- 포인트컷을 이용하면 메소드가 포함된 클래스의 패키지, 메소드 시그니처까지 정확하게 지정할 수 있다.
 \- expression 값을 설정하는 방법에 따라 필터링되는 메소드가 달라진다. execution(* spring.model.bbs.*Service.*(..)) 

|    *     | spring.model.bbs. | *service. |        *(..)         |
| :------: | :---------------: | :-------: | :------------------: |
| 리턴타입 |    패키지 경로    | 클래스명  | 메소드명 및 매개변수 |

(3) 어드바이스(Advice)
 \- 어드바이스는 횡단관심에 해당하는 공통 기능의 코드를 의미한다.  독립된 클래스의 메소드로 작성된다.  
 \- 어드바이스의 메소드가 언제 동작할지는 스프링 설정파일을 통해서 지정한다.

(4) 위빙(Weaving)
 \- 포인트컷으로 지정한 핵심관심 메소드가 호출될때, 어드바이스에 해당하는 횡단관심 메소드가 삽입되는 과정을 의미한다.
 \- 이 위빙을 통해서 비즈니스 메소드를 수정하지 않고도 횡단관심에 해당하는 기능을 추가하거나 변경할 수 있다.
 \- 위빙을 처리하는 방식는 컴파일타임(Compiletime)위빙, 로딩 타임(Loadingtime) 위빙, 런타임(Runtime) 위빙이 있지만 스프링에서는 런타임 위빙 방식을 지원한다.

(5) 애스팩트(Aspect) 또는 어드바이저(Advisor)
 \- AOP의 핵심은 애스팩트이다. 애스팩트는 포인트컷과 어드바이스의 결합이다.
 \- 어떤 포인트컷 메소드에 대해서 어떤 어드바이스 메소드를 실행할지 결정한다.
 \- 이 애스팩트 설정에 따라 AOP의 동작방식이 결정된다.
    
(6) Proxy 
 \- 위빙될때 생성되는 객체이다.
 \- Spring AOP의 동작을 전반적으로 제어 하는 객체이다.  

![image](https://user-images.githubusercontent.com/101780699/174242480-91a14b49-8355-462e-baca-82ea4dcd2144.png)

### 3. Spring의  AOP 
 \- Spring에서  AOP는 **런타임시에  AOP를 적용**하므로 소스코드나 클래스 정보를 변경 하지 않는다.
 \- Spring에서  AOP는 **프록시를 이용하여  AOP를 적용**한다. 
 \- 프록시 기반  AOP는 핵심로직을 구현한  객체에 직접 접근하는 것이 아니라 중간에 프록시를 생성하여 프록시를 통해서 핵심로직을 구현한 객체에 접근한다. (프록시 호출 그림 참조 )
 \- 프록시 기반에서는 **메서드 호출때에만 Advice를 적용**할 수 있다. 필드값 변경과 같은 Joinpoint에 대해서는 적용할 수 없다. 


### 4. AOP Transaction 구현
 \- 댓글이 있는 게시판 글을 삭제하면 부모를 참조하는 자식레코드가 있어서 삭제가 안된다.
 \- 자식레코드 삭제 후 부모레코드를 삭제한다.
 \- 두개의 작업을 Transaction을 이용해서 작성한다.
 \- 일반 작업프로세스 :  controller -> dao -> mybatis -> oralce
 \- 트랜잭션을 적용한 작업프로세스 :
  controller -> service -> dao -> mybatis ->oracle
 \-  Service 패턴을 적용해서 트랜잭션을 위한 BbsService.java 생성한다.

(1) Service 패턴을 적용한 비즈니스 클래스 선언

BbsServiceImpl.java 수정

```java
package com.study.model;

import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service("com.study.model.BbsServiceImpl")
public class BbsServiceImpl implements BbsService {

  @Autowired
  private BbsMapper mapper;
  
  @Autowired
  private ReplyMapper rmapper;
  
  public List<BbsDTO> list(Map map) {
    // TODO Auto-generated method stub
    return mapper.list(map);
  }

  @Override
  public int total(Map map) {
    // TODO Auto-generated method stub
    return mapper.total(map);
  }

  @Override
  public void upViewcnt(int bbsno) {
    mapper.upViewcnt(bbsno);
    
  }

  @Override
  public BbsDTO read(int bbsno) {
    // TODO Auto-generated method stub
    return mapper.read(bbsno);
  }

  @Override
  public int create(BbsDTO dto) {
    // TODO Auto-generated method stub
    return mapper.create(dto);
  }

  @Override
  public int passCheck(Map map) {
    // TODO Auto-generated method stub
    return mapper.passCheck(map);
  }

  @Override
  public int update(BbsDTO dto) {
    // TODO Auto-generated method stub
    return mapper.update(dto);
  }

  @Override
  public void delete(int bbsno) {
    // TODO Auto-generated method stub
    rmapper.bdelete(bbsno);
    mapper.delete(bbsno);
  }

  @Override
  public BbsDTO readReply(int bbsno) {
    // TODO Auto-generated method stub
    return mapper.readReply(bbsno);
  }

  @Override
  public void upAnsnum(Map map) {

    mapper.upAnsnum(map);
    
  }

  @Override
  public int createReply(BbsDTO dto) {
    // TODO Auto-generated method stub
    return mapper.createReply(dto);
  }

  @Override
  public int checkRefnum(int bbsno) {
    // TODO Auto-generated method stub
    return mapper.checkRefnum(bbsno);
  }

}

```

ReplyService.java 수정

```java
package com.study.model;

import java.util.List;
import java.util.Map;

public interface BbsService {
  List<BbsDTO> list(Map map);
  int total(Map map);
  void upViewcnt(int bbsno);
  BbsDTO read(int bbsno);
  int create(BbsDTO dto);
  int passCheck(Map map);
  int update(BbsDTO dto);
  void delete(int bbsno);
  BbsDTO readReply(int bbsno);
  void upAnsnum(Map map);
  int createReply(BbsDTO dto);
  int checkRefnum(int bbsno);
}

```



ReplyMapper.java 수정

```java
package com.study.model;
 
import java.util.List;
import java.util.Map;
 
public interface ReplyMapper{
 
   int create(ReplyDTO replyDTO);
 
   List<ReplyDTO> list(Map map);
 
   ReplyDTO read(int rnum);
  
   int update(ReplyDTO replyDTO); 
   
   void delete(int bbsno);
 
   int total(int bbsno);

  void bdelete(int bbsno);
}
```

BbsController.java 수정

```java
 @PostMapping("/bbs/delete")
  public String delete(int bbsno, String passwd, String oldfile) {
    Map map = new HashMap();
    map.put("bbsno", bbsno);
    map.put("passwd", passwd);

    String upDir = UploadBbs.getUploadDir();

    int pflag = dao.passCheck(map);
    String url = "./passwdError";
    
    if (pflag==1) {
       try {
         dao.delete(bbsno);
         url = "redirect:./list";
         if(oldfile != null)
            Utility.deleteFile(upDir, oldfile);
       }catch(Exception e) {
         e.printStackTrace();
         url = "./error";
       }
    }
 
    return url;   
  }
```



reply.xml 수정 bdelete 추가

```xml
<delete id="bdelete" parameterType="int">
DELETE FROM reply
WHERE bbsno = #{bbsno}
</delete>
```

build.gradel 수정 

```java
 // https://mvnrepository.com/artifact/org.aspectj/aspectjweaver
 implementation group: 'org.aspectj', name: 'aspectjweaver', version: '1.9.6'
```

bbs/TransactionAspect.java 생성

```java
package com.study.bbs;
import java.util.Collections;
import java.util.List;
import org.springframework.aop.Advisor;
import org.springframework.aop.aspectj.AspectJExpressionPointcut;
import org.springframework.aop.support.DefaultPointcutAdvisor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.interceptor.MatchAlwaysTransactionAttributeSource;
import org.springframework.transaction.interceptor.RollbackRuleAttribute;
import org.springframework.transaction.interceptor.RuleBasedTransactionAttribute;
import org.springframework.transaction.interceptor.TransactionInterceptor;
@Configuration
public class TransactionAspect {
    @Autowired
    private PlatformTransactionManager transactionManager;
    // 포인트 컷 선언: 트랜잭션이 적용되는 시점
    // private static final String EXPRESSION = "execution(* com.study..service.*Impl.*(..))";
    // om.study 패키지로 시작하며 Impl로 끝나는 class의 모든 메소드에 트랜잭션 적용
    private static final String EXPRESSION = "execution(* com.study..model.*Impl.*(..))";
    @Bean
    public TransactionInterceptor transactionAdvice() {
        List<RollbackRuleAttribute> rollbackRules = Collections.singletonList(new RollbackRuleAttribute(Exception.class));
        RuleBasedTransactionAttribute transactionAttribute = new RuleBasedTransactionAttribute();
        transactionAttribute.setRollbackRules(rollbackRules);
        transactionAttribute.setName("*");
        MatchAlwaysTransactionAttributeSource attributeSource = new MatchAlwaysTransactionAttributeSource();
        attributeSource.setTransactionAttribute(transactionAttribute);
        return new TransactionInterceptor(transactionManager, attributeSource);
    }
    @Bean
    public Advisor transactionAdvisor() {
        AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut();
        pointcut.setExpression(EXPRESSION);
        return new DefaultPointcutAdvisor(pointcut, transactionAdvice());
    }
}
```

