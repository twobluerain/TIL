## CREATE, LIST



### 4. controller class 작성

NoticeController.java 수정 NoticeService 추가, create 추가, list 추가

```java
  @Autowired
  @Qualifier("com.study.model.NoticeServiceImpl")
  private NoticeService service;
  
  @GetMapping("/notice/create")
  public String create() {
    
    return "/create";
  }
  
  @PostMapping("/notice/create")
  public String create(NoticeDTO dto) {
    
    if(service.create(dto)==1) {
      return "redirect:list";
    }else {
      return "error";
    }
  }

  @RequestMapping("list")
  public String list(HttpServletRequest request) {
    // 검색관련------------------------
    String col = Utility.checkNull(request.getParameter("col"));
    String word = Utility.checkNull(request.getParameter("word"));
 
    if (col.equals("total")) {
      word = "";
    }
  @RequestMapping("list")
  public String list(HttpServletRequest request) {
    // 검색관련------------------------
    String col = Utility.checkNull(request.getParameter("col"));
    String word = Utility.checkNull(request.getParameter("word"));
 
    if (col.equals("total")) {
      word = "";
    }
  
  // 페이지관련-----------------------
  int nowPage = 1;// 현재 보고있는 페이지
  if (request.getParameter("nowPage") != null) {
    nowPage = Integer.parseInt(request.getParameter("nowPage"));
  }
  int recordPerPage = 3;// 한페이지당 보여줄 레코드갯수

  // DB에서 가져올 순번-----------------
  int sno = ((nowPage - 1) * recordPerPage) ;
  // int eno = nowPage * recordPerPage;

  Map map = new HashMap();
  map.put("col", col);
  map.put("word", word);
  map.put("sno", sno);
  map.put("cnt", recordPerPage);

  int total = service.total(map);

  List<NoticeDTO> list = service.list(map);

  String paging = Utility.paging(total, nowPage, recordPerPage, col, word);

  // request에 Model사용 결과 담는다
  request.setAttribute("list", list);
  request.setAttribute("nowPage", nowPage);
  request.setAttribute("col", col);
  request.setAttribute("word", word);
  request.setAttribute("paging", paging);

  // view페이지 리턴
  return "/list";
}
```

spring_bbs 에 Utility.java notice/com.study.utility패키지 생성 후 붙여넣기,  수정

```java
package com.study.utility;

import java.io.File;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.OutputStream;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;

import org.springframework.web.multipart.MultipartFile;


public class Utility {
  /**
   * 오늘,어제,그제 날짜 가져오기
   * 
   * @return List- 날짜들 저장 SimpleDateFormat("yyyy-MM-dd")
   */
  public static List<String> getDay() {
    List<String> list = new ArrayList<String>();

    SimpleDateFormat sd = new SimpleDateFormat("yyyy-MM-dd");
    Calendar cal = Calendar.getInstance();
    for (int j = 0; j < 3; j++) {
      list.add(sd.format(cal.getTime()));
      cal.add(Calendar.DATE, -1);
    }

    return list;
  }

  /**
   * 등록날짜와 오늘,어제,그제날짜와 비교
   * 
   * @param wdate - 등록날짜
   * @return - true:오늘,어제,그제중 등록날짜와 같음 false:오늘,어제,그제 날짜가 등록날짜와 다 다름
   */
  public static boolean compareDay(String wdate) {
    boolean flag = false;
    List<String> list = getDay();
    if (wdate.equals(list.get(0)) || wdate.equals(list.get(1)) || wdate.equals(list.get(2))) {
      flag = true;
    }

    return flag;
  }

  public static String checkNull(String str) {
    if (str == null) {
      str = "";
    }
    return str;
  }

  /**
   * @param totalRecord   전체 레코드수
   * @param nowPage       현재 페이지
   * @param recordPerPage 페이지당 레코드 수
   * @param col           검색 컬럼
   * @param word          검색어
   * @return 페이징 생성 문자열
   */
  public static String paging(int totalRecord, int nowPage, int recordPerPage, String col, String word) {
    int pagePerBlock = 5; // 블럭당 페이지 수
    int totalPage = (int) (Math.ceil((double) totalRecord / recordPerPage)); // 전체 페이지
    int totalGrp = (int) (Math.ceil((double) totalPage / pagePerBlock));// 전체 그룹
    int nowGrp = (int) (Math.ceil((double) nowPage / pagePerBlock)); // 현재 그룹
    int startPage = ((nowGrp - 1) * pagePerBlock) + 1; // 특정 그룹의 페이지 목록 시작
    int endPage = (nowGrp * pagePerBlock); // 특정 그룹의 페이지 목록 종료

    StringBuffer str = new StringBuffer();
    str.append("<div style='text-align:center'>");
    str.append("<ul class='pagination'> ");
    int _nowPage = (nowGrp - 1) * pagePerBlock; // 10개 이전 페이지로 이동
    if (nowGrp >= 2) {
      str.append("<li><a href='./list?col=" + col + "&word=" + word + "&nowPage=" + _nowPage + "'>이전</A></li>");
    }

    for (int i = startPage; i <= endPage; i++) {
      if (i > totalPage) {
        break;
      }

      if (nowPage == i) {
        str.append("<li class='active'><a href=#>" + i + "</a></li>");
      } else {
        str.append("<li><a href='./list?col=" + col + "&word=" + word + "&nowPage=" + i + "'>" + i + "</A></li>");
      }
    }

    _nowPage = (nowGrp * pagePerBlock) + 1; // 10개 다음 페이지로 이동
    if (nowGrp < totalGrp) {
      str.append("<li><A href='./list?col=" + col + "&word=" + word + "&nowPage=" + _nowPage + "'>다음</A></li>");
    }
    str.append("</ul>");
    str.append("</div>");

    return str.toString();
  }

  public static String saveFileSpring(MultipartFile mf, String basePath) {
    InputStream inputStream = null;
    OutputStream outputStream = null;
    String filename = "";
    long filesize = mf.getSize();
    String originalFilename = mf.getOriginalFilename();
    try {
      if (filesize > 0) { // 파일이 존재한다면
        // 인풋 스트림을 얻는다.
        inputStream = mf.getInputStream();

        File oldfile = new File(basePath, originalFilename);

        if (oldfile.exists()) {
          for (int k = 0; true; k++) {
            // 파일명 중복을 피하기 위한 일련 번호를 생성하여
            // 파일명으로 조합
            oldfile = new File(basePath, "(" + k + ")" + originalFilename);

            // 조합된 파일명이 존재하지 않는다면, 일련번호가
            // 붙은 파일명 다시 생성
            if (!oldfile.exists()) { // 존재하지 않는 경우
              filename = "(" + k + ")" + originalFilename;
              break;
            }
          }
        } else {
          filename = originalFilename;
        }
        String os = System.getProperty("os.name").toLowerCase();
        System.out.println("os: " + os); // windows 10, linux, mac os x
        String serverFullPath = null;
        if (os.equals("mac os x")) { // Mac
          System.out.println("맥");
          serverFullPath = basePath + "/" + filename;
        } else if (os.equals("windows 10")) {
          System.out.println("os: " + os);
          serverFullPath = basePath + "\\" + filename;
        } else if (os.equals("linux")) {
          System.out.println("리눅스");
          serverFullPath = basePath + "/" + filename;
        }

        System.out.println("fileName: " + filename);
        System.out.println("serverFullPath: " + serverFullPath);

        outputStream = new FileOutputStream(serverFullPath);

        // 버퍼를 만든다.
        int readBytes = 0;
        byte[] buffer = new byte[8192];

        while ((readBytes = inputStream.read(buffer, 0, 8192)) != -1) {
          outputStream.write(buffer, 0, readBytes);
        }
        outputStream.close();
        inputStream.close();

      }

    } catch (Exception e) {
      e.printStackTrace();
    } finally {

    }

    return filename;
  }

  public static void deleteFile(String upDir, String oldfile) {
    File file = new File(upDir, oldfile);
    if (file.exists())
      file.delete();

  }
  
  public static String rpaging(int total, int nowPage, int recordPerPage, String col, String word, String url,
      int nPage) {
    int pagePerBlock = 5; // 블럭당 페이지 수
    int totalPage = (int) (Math.ceil((double) total / recordPerPage)); // 전체 페이지
    int totalGrp = (int) (Math.ceil((double) totalPage / pagePerBlock));// 전체 그룹
    int nowGrp = (int) (Math.ceil((double) nPage / pagePerBlock)); // 현재 그룹
    int startPage = ((nowGrp - 1) * pagePerBlock) + 1; // 특정 그룹의 페이지 목록 시작
    int endPage = (nowGrp * pagePerBlock); // 특정 그룹의 페이지 목록 종료
 
    StringBuffer str = new StringBuffer();
    str.append("<div style='text-align:center'>");
    str.append("<ul class='pagination'> ");
    int _nowPage = (nowGrp - 1) * pagePerBlock; // 10개 이전 페이지로 이동
 
    if (nowGrp >= 2) {
      str.append("<li><a href='" + url + "?col=" + col + "&word=" + word + "&nowPage=" + nowPage 
          + "&nPage=" + _nowPage + "'>이전</A></li>");
    }
 
    for (int i = startPage; i <= endPage; i++) {
      if (i > totalPage) {
        break;
      }
 
      if (nPage == i) {
        str.append("<li class='active'><a href=#>" + i + "</a></li>");
      } else {
        str.append("<li><a href='" + url + "?col=" + col + "&word=" + word + "&nowPage=" + nowPage 
            + "&nPage=" + i + "'>" + i + "</A></li>");
      }
    }
 
    _nowPage = (nowGrp * pagePerBlock) + 1; // 10개 다음 페이지로 이동
    if (nowGrp < totalGrp) {
      str.append("<li><A href='" + url + "?col=" + col + "&word=" + word + "&nowPage=" + nowPage 
          + "&nPage=" + _nowPage + "'>다음</A></li>");
    }
    str.append("</ul>");
    str.append("</div>");
 
    return str.toString();
 
  }

}

```



### 6. view 작성 및 tiles.xml 등록

views/createForm.jsp 생성

```jsp
<%@ page contentType="text/html; charset=UTF-8" %> 
 
<!DOCTYPE html> 
<html> 
<head>
  <title>notice</title>
  <meta charset="utf-8">
  <script type="text/JavaScript">
        
 function checkIn(f){
         if (f.wname.value == ""){
              alert("글쓴이를 입력하세요");
              f.wname.focus()
              return false;
         }
         if (f.title.value == ""){
              alert("제목를 입력하세요");
              f.title.focus();
              return false;
         }
         if (f.content.value == '') {
             window.alert('내용을 입력해 주세요.');
             f.content.focus();
             return false;
         }
         if (f.passwd.value == ""){
             alert("패스워드를 입력하세요");
             f.passwd.focus();
             return false;
         }
 }
 </script>
</head>
<body> 
<div class="container">
<h2 class="col-sm-offset-2 col-sm-10">공지 생성</h2>
<form class="form-horizontal" 
      action="./create"
      method="post"
      onsubmit="return checkIn(this)"
      >
 
  <div class="form-group">
    <label class="control-label col-sm-2" for="wname">작성자</label>
    <div class="col-sm-6">
      <input type="text" name="wname" id="wname" class="form-control">
    </div>
  </div>
  <div class="form-group">
    <label class="control-label col-sm-2" for="title">제목</label>
    <div class="col-sm-8">
      <input type="text" name="title" id="title" class="form-control">
    </div>
  </div>
  
  <div class="form-group">
    <label class="control-label col-sm-2" for="content">내용</label>
    <div class="col-sm-8">
    <textarea rows="12" cols="7" id="content" name="content" class="form-control"></textarea>
    </div>
  </div>
  
  <div class="form-group">
    <label class="control-label col-sm-2" for="passwd">비밀번호</label>
    <div class="col-sm-6">
      <input type="password" name="passwd" id="passwd" class="form-control">
    </div>
  </div>
   <div class="form-group">
   <div class="col-sm-offset-2 col-sm-5">
    <button class="btn">등록</button>
    <button type="reset" class="btn">취소</button>
   </div>
 </div>
</form>
</div>
</body> 
</html> 
```

list.jsp 생성

```jsp
<%@ page contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="util" uri="/ELFunctions" %>
 
<!DOCTYPE html> 
<html> 
<head>
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
   <script type="text/javascript">
     function read(noticeno){
       var url = "read";
       url += "?noticeno="+noticeno;
       url += "&col=${col}";
       url += "&word=${word}";
       url += "&nowPage=${nowPage}";
       location.href=url;
 
     }  
  </script>
 
</head>
<body>
<div class="container">
 
   <h2>공지 사항</h2>
  <form class="form-inline" action="./list">
    <div class="form-group">
      <select class="form-control" name="col">
        <option value="wname"
        <c:if test= "${col=='wname'}"> selected </c:if>
        >성명</option>
        <option value="title"
        <c:if test= "${col=='title'}"> selected </c:if>
        >제목</option>
        <option value="content"
        <c:if test= "${col=='content'}"> selected </c:if>
        >내용</option>
        <option value="title_content"
        <c:if test= "${col=='title_content'}"> selected</c:if>
        >제목+내용</option>
        <option value="total"
        <c:if test= "${col=='total'}"> selected </c:if>
        >전체출력</option>       
     </select>
    </div>
    <div class="form-group">
      <input type="text" class="form-control" placeholder="Enter 검색어" 
      name="word" value="${word}">
    </div>
    <button type="submit" class="btn btn-default" >검색</button>
    <button type="button" class="btn btn-default" onclick="location.href='./create'">등록</button>
  </form>
  
  <table class="table table-striped">
   <thead>
    <tr>
    <th>번호</th>
    <th>제목</th>
    <th>작성자</th>
    <th>등록날짜</th>
    <th>조회수</th>
    </tr>
   </thead>
   <tbody>
 
<c:choose>   
<c:when test="${empty list}">
   <tr><td colspan="6">등록된 글이 없습니다.</td>
</c:when>
<c:otherwise>
  
   <c:forEach var="dto" items="${list}"> 
   
   <tr>
    <td>${dto.noticeno}</td>
    <td>
    <a href="javascript:read('${dto.noticeno}')">${dto.title}</a>
 
    <c:if test="${util:newImg(fn:substring(dto.rdate,0,10)) }">
         <img src="${pageContext.request.contextPath}/images/new.gif"> 
    </c:if>
 
    </td>
    <td>${dto.wname}</td>
    <td>${dto.rdate}</td>
    <td>${dto.cnt}</td>
   </tr>
   </c:forEach>
   </c:otherwise>
   </c:choose>
 
   </tbody>
  
  </table>
  <div>
      ${paging}
  </div>
</div>
</body> 
</html> 
```

tiles.xml 수정 create, list 추가

```xml
<definition name="/create" extends="main">
    <put-attribute name="title" value="등록"></put-attribute>
    <put-attribute name="body"
      value="/WEB-INF/views/createForm.jsp" />
  </definition>
  <definition name="/list" extends="main">
    <put-attribute name="title" value="목록"></put-attribute>
    <put-attribute name="body"
      value="/WEB-INF/views/list.jsp" />
  </definition>
```



### 7. new이미지 생성을 위한 tld 파일 제작
\- WEB-INF/tld/tld-el-functions.tld 수정

```java
<?xml version="1.0" encoding="UTF-8" ?>

<taglib xmlns="http://java.sun.com/xml/ns/j2ee"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee 
                        web-jsptaglibrary_2_0.xsd"
	version="2.0">

	<description>EL에서 함수실행</description>
	<tlib-version>1.0</tlib-version>
	<uri>/ELFunctions</uri>

	<function>
		<description>new 이미지 출력</description>
		<name>newImg</name>
		<function-class>
			com.study.utility.Utility
		</function-class>
		<function-signature>
			boolean compareDay(java.lang.String)
		</function-signature>
	</function>
</taglib> 
```

![image](https://user-images.githubusercontent.com/101780699/173969725-467bd8ae-64b7-4864-be1c-08bbed8ead28.png)

---

---



## [01] 공지사항 조회, 수정, 삭제, 패스워드 검증 처리

### 1. Mybatis Mapper XML

notice.xml 수정 조회수 기능 추가

```xml
<!-- 조회수 증가 -->
  <update id="upCnt" parameterType="int">
    update notice              
    set cnt = cnt + 1 
    where noticeno = #{noticeno}         
  </update>
  
  <!-- 조회 -->
  <select id="read" resultType="com.study.model.NoticeDTO" parameterType="int">
    SELECT noticeno, title, content, wname, passwd, cnt, rdate
    FROM notice
    WHERE noticeno=#{noticeno}
  </select>
```

### 2. NoticeMapper.java 

NoticaMapper.java 수정 upCnt, read 추가

```java
package com.study.model;

import java.util.List;
import java.util.Map;
   
  public interface NoticeMapper {
    int create(NoticeDTO dto);
    List<NoticeDTO> list(Map map);
    int total(Map map); 
    void upCnt(int noticeno);
    NoticeDTO read(int noticeno);
}
```

NoticeService.java 수정 upCnt, read 추가

```java
package com.study.model;
 
import java.util.List;
import java.util.Map;
 
public interface NoticeService {
  int create(NoticeDTO dto);
  List<NoticeDTO> list(Map map);
  int total(Map map);
  void upCnt(int noticeno);
  NoticeDTO read(int noticeno);
}
```

NoticeServiceImpl.java 수정 upCnt, read 추가

```java
  @Override
  public void upCnt(int noticeno) {
    // TODO Auto-generated method stub
    mapper.upCnt(noticeno);
    
  }

  @Override
  public NoticeDTO read(int noticeno) {
    // TODO Auto-generated method stub
    return mapper.read(noticeno);
  }
```

NoticeController 수정 read 추가

```java
  @GetMapping("/notice/read")
  public String read(int noticeno,Model model) {
    
    service.upCnt(noticeno);
    
    NoticeDTO dto = service.read(noticeno);
    
    String content = dto.getContent().replaceAll("\r\n", "<br>");
    
    dto.setContent(content);
    
    model.addAttribute("dto",dto);
    
    return "/read";
  }
```

read.jsp 생성

```jsp
<%@ page contentType="text/html; charset=UTF-8"%> 
<!DOCTYPE html>
<html>
<head>
<title>조회</title>
<meta charset="utf-8">
 
<script type="text/javascript">
    function updateM(){
      var url = "update";
      url += "?noticeno=${dto.noticeno}";
      location.href=url;
    }
    function deleteM(){
      var url = "delete";
      url += "?noticeno=${dto.noticeno}";
      location.href=url;
    }
    
    
    function listM(){
        var url = "list";
        url += "?nowPage=${param.nowPage}";
        url += "&col=${param.col}";
        url += "&word=${param.word}";
                                location.href = url;
                }
</script>
 
</head>
<body>
        <div class="container">
 
                <h2>조회</h2>
                <div class="panel panel-default">
                        <div class="panel-heading">작성자</div>
                        <div class="panel-body">${dto.wname}</div>
 
                        <div class="panel-heading">제목</div>
                        <div class="panel-body">${dto.title}</div>
 
                        <div class="panel-heading">내용</div>
                        <div class="panel-body">${dto.content}</div>
 
                        <div class="panel-heading">조회수</div>
                        <div class="panel-body">${dto.cnt}</div>
 
                        <div class="panel-heading">등록일</div>
                        <div class="panel-body">${dto.rdate}</div>
 
                </div>
                <div>
                        <button type="button" class="btn" onclick="location.href='./create'">등록</button>
                        <button type="button" class="btn" onclick="updateM()">수정</button>
                        <button type="button" class="btn" onclick="deleteM()">삭제</button>
                        <button type="button" class="btn" onclick="listM()">목록</button>
                </div>
         </div>
</body>
</html>
```

![image](https://user-images.githubusercontent.com/101780699/173969751-7cfe8017-34dc-45e1-85a9-4341f130b9c3.png)





---

---



updateForm.jsp 생성

```jsp
<%@ page contentType="text/html; charset=UTF-8" %> 
<!DOCTYPE html> 
<html> 
<head>
  <title>수정</title>
  <meta charset="utf-8">
 
</head>
<body> 
 
<div class="container">
<h1 class="col-sm-offset-2 col-sm-10">게시판 수정</h1>
<form class="form-horizontal" 
      action="./update"
      method="post"
      >
<input type="hidden" name="noticeno" value="${dto.noticeno}">
  <div class="form-group">
    <label class="control-label col-sm-2" for="wname">작성자</label>
    <div class="col-sm-6">
      <input type="text" name="wname" id="wname" 
      class="form-control" value="${dto.wname}">
    </div>
  </div>
  <div class="form-group">
    <label class="control-label col-sm-2" for="title">제목</label>
    <div class="col-sm-8">
      <input type="text" name="title" id="title" 
      class="form-control" value="${dto.title}">
    </div>
  </div>
  
  <div class="form-group">
    <label class="control-label col-sm-2" for="content">내용</label>
    <div class="col-sm-8">
    <textarea rows="12" cols="7" id="content" name="content" 
    class="form-control">${dto.content}</textarea>
    </div>
  </div>
  
  <div class="form-group">
    <label class="control-label col-sm-2" for="passwd">비밀번호</label>
    <div class="col-sm-6">
      <input type="password" name="passwd" id="passwd" class="form-control">
    </div>
  </div>
  
   <div class="form-group">
   <div class="col-sm-offset-2 col-sm-5">
    <button class="btn">수정</button>
    <button type="reset" class="btn">취소</button>
   </div>
 </div>
</form>
</div>
</body> 
</html> 
```

deleteForm.jsp 생성

```jsp
<%@ page contentType="text/html; charset=UTF-8" %> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html> 
<html> 
<head>
  <title>삭제</title>
  <meta charset="utf-8">
  <style type="text/css">
  #red{
    color:red;
  }
  </style>
</head>
<body> 
<div class="container">
 
<h2 class="col-sm-offset-2 col-sm-10">삭제</h2>
<form class="form-horizontal" 
      action="./delete"
      method="post"
      >
  <input type="hidden" name="noticeno" value="${param.noticeno}">
  <div class="form-group">
    <label class="control-label col-sm-2" for="passwd">비밀번호</label>
    <div class="col-sm-6">
      <input type="password" name="passwd" id="passwd" class="form-control">
    </div>
  </div>
  
  <p id="red" class="col-sm-offset-2 col-sm-6">삭제하면 복구할 수 없습니다</p>
  
   <div class="form-group">
   <div class="col-sm-offset-2 col-sm-5">
    <button class="btn">삭제</button>
    <button type="reset" class="btn">취소</button>
   </div>
 </div>
</form>
 
</div>
</body> 
</html>
```

tiles.xml 수정 update, delete 추가

```xml
 <definition name="/update" extends="main">
    <put-attribute name="title" value="수정"></put-attribute>
    <put-attribute name="body"
      value="/WEB-INF/views/updateForm.jsp" />
  </definition>
  <definition name="/delete" extends="main">
    <put-attribute name="title" value="삭제"></put-attribute>
    <put-attribute name="body"
      value="/WEB-INF/views/deleteForm.jsp" />
  </definition>
```

NoticeController.java 수정 update, delete 추가

```java
  @GetMapping("/notice/update")
  public String update(int noticeno, Model model) {
    
    model.addAttribute("dto", service.read(noticeno));
 
    return "/update";
  }
 
  @PostMapping("/notice/update")
  public String update(NoticeDTO dto) {
 
    Map map = new HashMap();
    map.put("noticeno", dto.getNoticeno());
    map.put("passwd", dto.getPasswd());
    int pcnt = service.passwd(map);
    
    int cnt = 0;
    if (pcnt==1) {
      
      cnt = service.update(dto);
    }
 
    if (pcnt != 1) {
      return "./passwdError";
    } else if (cnt==1) {
      return "redirect:./list";
    } else {
      return "error";
    }
 
  }
 
  @GetMapping("/notice/delete")
  public String delete(int noticeno) {
 
    return "/delete";
  }
  
  @PostMapping("/notice/delete")
  public String delete(int noticeno, String passwd) {
 
    Map map = new HashMap();
    map.put("noticeno", noticeno);
    map.put("passwd", passwd);
    int pcnt = service.passwd(map);
    
    int cnt = 0;
    if (pcnt==1) {
      
      cnt = service.delete(noticeno);
    }
 
    if (pcnt != 1) {
      return "./passwdError";
    } else if (cnt==1) {
      return "redirect:./list";
    } else {
      return "error";
    }
 
  }
```

NoticeService.java 수정 update, delete 추가

```java
package com.study.model;
 
import java.util.List;
import java.util.Map;
 
public interface NoticeService {
  int create(NoticeDTO dto);
  List<NoticeDTO> list(Map map);
  int total(Map map);
  void upCnt(int noticeno);
  NoticeDTO read(int noticeno);
  int passwd(Map map);
  int update(NoticeDTO dto);
  int delete(int noticeno);
}
```

NoticeServiceImpl.java 수정 update, delete 추가

```java
package com.study.model;

import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service("com.study.model.NoticeServiceImpl")
public class NoticeServiceImpl implements NoticeService {

  @Autowired
  private NoticeMapper mapper;
  
  @Override
  public int create(NoticeDTO dto) {
    // TODO Auto-generated method stub
    return mapper.create(dto);
  }

  @Override
  public List<NoticeDTO> list(Map map) {
    // TODO Auto-generated method stub
    return mapper.list(map);
  }

  @Override
  public int total(Map map) {
    // TODO Auto-generated method stub
    return mapper.total(map);
  }

  @Override
  public void upCnt(int noticeno) {
    // TODO Auto-generated method stub
    mapper.upCnt(noticeno);
    
  }

  @Override
  public NoticeDTO read(int noticeno) {
    // TODO Auto-generated method stub
    return mapper.read(noticeno);
  }

  @Override
  public int passwd(Map map) {
    // TODO Auto-generated method stub
    return mapper.passwd(map);
  }

  @Override
  public int update(NoticeDTO dto) {
    // TODO Auto-generated method stub
    return mapper.update(dto);
  }

  @Override
  public int delete(int noticeno) {
    // TODO Auto-generated method stub
    return mapper.delete(noticeno);
  }

}

```

NoticeMapper.java 수정 update, delete 추가

```java
package com.study.model;

import java.util.List;
import java.util.Map;
   
  public interface NoticeMapper {
    int create(NoticeDTO dto);
    List<NoticeDTO> list(Map map);
    int total(Map map); 
    void upCnt(int noticeno);
    NoticeDTO read(int noticeno);
    int passwd(Map map); 
    int update(NoticeDTO noticeDTO); 
    int delete(int noticeno);
}

```

notice.xml 수정 update, delete 추가

```xml
 <!-- 패스워드 검사 -->
  <select id="passwd" resultType="int" parameterType="HashMap">
    SELECT COUNT(*) AS cnt
    FROM notice
    WHERE noticeno=#{noticeno} AND passwd=#{passwd}
  </select>   
 
  <!-- 수정 -->
  <update id="update"  parameterType="com.study.model.NoticeDTO">
    UPDATE notice
    SET title=#{title}, content=#{content}, wname=#{wname}
    WHERE noticeno=#{noticeno}
  </update>
 
  <!-- 삭제 -->
  <delete id="delete" parameterType="int">
    DELETE FROM notice
    WHERE noticeno=#{noticeno};
  </delete>   
```





---

---





## [01] shopping application 제작

### 1. Spring Starter Project 생성

(1) Name : shopping
  Group : com.study
  Package : com.study.shop

![image](https://user-images.githubusercontent.com/101780699/173977502-3e2bece4-730d-42b9-9a03-9070645e073c.png)

![image](https://user-images.githubusercontent.com/101780699/173977543-fa39b017-a746-4f4c-bb95-79370ba1128b.png)



(2) src/main/resources/application.properties 설정

\- 프로젝트에 사용되는 오라클 계정 설정

application.properties 수정

```properties
server.port=8000
# DEVTOOLS (DevToolsProperties)
spring.devtools.livereload.enabled=true
# jsp 설정
spring.mvc.view.prefix=/WEB-INF/views/
spring.mvc.view.suffix=.jsp
#mysql
spring.datasource.hikari.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.hikari.jdbc-url=jdbc:mysql://127.0.0.1:3306/webtest?useUnicode=true&characterEncoding=utf8
spring.datasource.hikari.username=javauser
spring.datasource.hikari.password=1234
# All DBMS
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=5000
```



(3) Jsp 의존성 추가

build.gradle 수정

```java
plugins {
	id 'org.springframework.boot' version '2.7.0'
	id 'io.spring.dependency-management' version '1.0.11.RELEASE'
	id 'java'
	id 'war'
}

group = 'com.study'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '11'

configurations {
	compileOnly {
		extendsFrom annotationProcessor
	}
}

repositories {
	mavenCentral()
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-jdbc'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'org.mybatis.spring.boot:mybatis-spring-boot-starter:2.2.2'
	compileOnly 'org.projectlombok:lombok'
	developmentOnly 'org.springframework.boot:spring-boot-devtools'
	runtimeOnly 'mysql:mysql-connector-java'
	annotationProcessor 'org.projectlombok:lombok'
	providedRuntime 'org.springframework.boot:spring-boot-starter-tomcat'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	implementation 'javax.servlet:jstl'
    implementation 'org.apache.tomcat.embed:tomcat-embed-jasper'
    //https://mvnrepository.com/artifact/org.apache.tiles/tiles-jsp
	implementation group: 'org.apache.tiles', name: 'tiles-jsp', version: '3.0.8'
	// https://mvnrepository.com/artifact/commons-io/commons-io       
  	implementation group: 'commons-io', name: 'commons-io', version: '2.6'
	// https://mvnrepository.com/artifact/commons-fileupload/commons-fileupload
	implementation group: 'commons-fileupload', name: 'commons-fileupload', version: '1.3.3'
	// https://mvnrepository.com/artifact/org.json/json
    implementation group: 'org.json', name: 'json', version: '20201115'
}

tasks.named('test') {
	useJUnitPlatform()
}

```



(4) Component scan "com.study.shop" 패키지 설정

ShoppingApplication.java 수정

```java
package com.study.shop;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.ComponentScan;

@SpringBootApplication
@ComponentScan(basePackages= {"com.study.*"})
public class ShoppingApplication {

	public static void main(String[] args) {
		SpringApplication.run(ShoppingApplication.class, args);
	}

}

```



(5) 관련폴더 생성

spring_bbs webapp 붙여넣기 수정

![image](https://user-images.githubusercontent.com/101780699/173978156-2ee65ea5-2f7a-43ef-9d8c-7925f8b74846.png)

css images js 폴더 생성

![image](https://user-images.githubusercontent.com/101780699/173978342-1d41edc5-c7f8-487b-9e6e-d5c6fd75e4aa.png)



### 2. MyBatis 설정

(1) DatabaseConfiguration 파일생성
 \- xml mapper 위치할 src/main/resources/mybatis 폴더 생성

DatabaseConfiguration.java 생성

```java
package com.study.shop;
import javax.sql.DataSource;
 
import org.apache.ibatis.session.SqlSessionFactory;
import org.mybatis.spring.SqlSessionFactoryBean;
import org.mybatis.spring.SqlSessionTemplate;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.ApplicationContext;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.PropertySource;
 
import com.zaxxer.hikari.HikariConfig;
import com.zaxxer.hikari.HikariDataSource;
 
@Configuration
@PropertySource("classpath:/application.properties")  // 설정 파일 위치
@MapperScan(basePackages= {"com.study.*"})
public class DatabaseConfiguration {
  @Autowired
  private ApplicationContext applicationContext;
  
  @Bean
  @ConfigurationProperties(prefix="spring.datasource.hikari") // 설정 파일의 접두사 선언 
  public HikariConfig hikariConfig() {
      return new HikariConfig();
  }
  
  @Bean
  public DataSource dataSource() throws Exception{
      DataSource dataSource = new HikariDataSource(hikariConfig());
      System.out.println(dataSource.toString());  // 정상적으로 연결 되었는지 해시코드로 확인
      return dataSource;
  }
  
  @Bean
  public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception{
      SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean();
      sqlSessionFactoryBean.setDataSource(dataSource);
      sqlSessionFactoryBean.setMapperLocations(applicationContext.getResources("classpath:/mybatis/**/*.xml"));   
      return sqlSessionFactoryBean.getObject();
  }
  
  @Bean
  public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory){
      return new SqlSessionTemplate(sqlSessionFactory);
  }
}

```

TilesConfiguration.java 생성

```java
package com.study.shop;
 
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.view.tiles3.TilesConfigurer;
import org.springframework.web.servlet.view.tiles3.TilesView;
import org.springframework.web.servlet.view.tiles3.TilesViewResolver;
 
@Configuration
public class TilesConfiguration {
  @Bean
  public TilesConfigurer tilesConfigurer() {
      final TilesConfigurer configurer = new TilesConfigurer();
      //해당 경로에 tiles.xml 파일을 넣음
      configurer.setDefinitions(new String[]{"classpath:/templates/tiles.xml"});
      configurer.setCheckRefresh(true);
      return configurer;
  }
 
  @Bean
  public TilesViewResolver tilesViewResolver() {
      final TilesViewResolver tilesViewResolver = new TilesViewResolver();
      tilesViewResolver.setViewClass(TilesView.class);
      return tilesViewResolver;
  }
}

```

(2) 설정 및 테스트

templates/tiles.xml 생성

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE tiles-definitions PUBLIC
       "-//Apache Software Foundation//DTD Tiles Configuration 3.0//EN"
       "http://tiles.apache.org/dtds/tiles-config_3_0.dtd">
 
<tiles-definitions>
  <!-- main -->
  <definition name="main"
    template="/WEB-INF/views/template/template.jsp">
    <put-attribute name="header"
      value="/WEB-INF/views/template/top.jsp" />
  </definition>
  <definition name="/home" extends="main">
    <put-attribute name="title" value="기본페이지"></put-attribute>
    <put-attribute name="body"
      value="/WEB-INF/views/index.jsp" />
  </definition>
  
</tiles-definitions>
```

ShoppingApplicationTests 수정

```java
package com.study.shop;

import org.junit.jupiter.api.Test;
import org.mybatis.spring.SqlSessionTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class ShoppingApplicationTests {

  @Autowired
  private SqlSessionTemplate sqlSession;
 
@Test
void contextLoads() {
}
 
@Test
  public void testSqlSession() throws Exception{
    System.out.println(sqlSession.toString());
  }
}


```

![image](https://user-images.githubusercontent.com/101780699/173978902-0ab86e7f-8ca2-47cb-a6bd-3ababe523879.png)



## [01] Workbench를 이용한 DBMS 모델링

### 1. 테이블 생성

(1) MySQL Workbench [File] -> [New Model] 
  \- [Model Overview] 패널에서 'Add Diagram' 더블클릭

![image](https://user-images.githubusercontent.com/101780699/173979455-7e78edeb-b015-43e3-861d-b395099872b9.png)

![image](https://user-images.githubusercontent.com/101780699/173979463-535c3e46-ec48-4981-832f-f65932747360.png)

![image](https://user-images.githubusercontent.com/101780699/173979480-12bb6bbb-40dd-45c7-a925-e33287ed4468.png)



![image](https://user-images.githubusercontent.com/101780699/173979564-711ebb7c-9e5c-4b4a-b4e7-c8841aaba887.png)



## [01] Member 테이블 모델링
### 1. 회원
(1) Workbench 에서 [File] - [Open Model] - shopping.mwb 파일 선택
\- categrp, cate 지우고 category 테이블만 만든다.
\- member table에서 컬럼 추가하기 (member table 더블클릭)



### 2. 회원SQL 제작
\- javauser으로 들어가서 member 테이블 생성
\- member테이블 선택하여 Copy SQL to Clipboard 선택 후 
 복사하여 실행한다.
\- mname 컬럼의 내용을 아래처럼 수정한다.



![image](https://user-images.githubusercontent.com/101780699/173980501-82afb19e-bfdd-4011-b8cf-b7145379d319.png)

```sql
CREATE TABLE IF NOT EXISTS `webtest`.`member` (
  `id` VARCHAR(10) NOT NULL,
  `passwd` VARCHAR(20) NOT NULL,
  `mname` VARCHAR(20)  NOT NULL,
  `tel` VARCHAR(14) NULL,
  `email` VARCHAR(50) NOT NULL,
  `zipcode` VARCHAR(7) NULL,
  `address1` VARCHAR(150) NULL,
  `address2` VARCHAR(50) NULL,
  `job` VARCHAR(20) NOT NULL,
  `mdate` DATE NOT NULL,
  `fname` VARCHAR(50) NOT NULL DEFAULT 'member.jpg',
  `grade` VARCHAR(1) NOT NULL DEFAULT 'H',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `email_UNIQUE` (`email` ASC) VISIBLE)
ENGINE = InnoDB;
```



※ 제약 조건 

\- NOT NULL: INSERT SQL에서 필수 입력. 

\- UNIQUE : 컬럼에 중복된 값이 올 수 없음. 

\- PRIMARY KEY (id): 기본적으로 UNIQUE의 성질을 포함하면서 레코드를 

 구분하는 기준 컬럼의 값. 



```sql
-- create 
INSERT INTO member(id, passwd, mname, tel, email, zipcode,  
address1,address2, job, mdate, fname, grade) 
VALUES('user1', '1234', '개발자1', '123-1234', 'email1@mail.com',  
'123-123','인천시', '남동구' ,'A01', sysdate(), 'member.jpg', 'H'); 
 
INSERT INTO member(id, passwd, mname, tel, email, zipcode,  
address1,address2, job, mdate, fname, grade) 
VALUES('user2', '1234', '개발자2', '123-1234', 'email2@mail.com',  
'123-123','광명시','남동구' ,'A01', sysdate(), 'man.jpg', 'H'); 
 
INSERT INTO member(id, passwd, mname, tel, email, zipcode,  
address1,address2, job, mdate, fname, grade) 
VALUES('user3', '1234', '개발자3', '123-1234', 'email3@mail.com',  
'123-123','용인시','남동구' ,'A01', sysdate(), 'myface.jpg', 'H'); 
 
-- 관리자 계정
INSERT INTO member(id, passwd, mname, tel, email, zipcode,  
address1,address2, job, mdate, fname, grade) 
VALUES('admin', '1234', '관리자', '02-1234-1234', 'admin@mail.com',  
'123-123','서울시 서초구','남부터미널' ,'A01', sysdate(), 'member.jpg', 'A');  
 
-- 중복 아이디 검사 관련 SQL 
-- 0: 중복 아님, 1: 중복  
SELECT COUNT(id)  
FROM member  
WHERE id='user1'; 
 
 
-- 이메일 중복 확인
SELECT COUNT(email) as cnt  
FROM member  
WHERE email='email3@mail.com'; 
 
 
-- user1 회원 정보 보기 
SELECT id, passwd, mname, tel, email, zipcode, address1, address2, 
    job, mdate, fname, grade 
FROM member  
WHERE id='user1'; 
 
 
-- 회원 사진 이미지의 수정
UPDATE member 
SET fname='' 
WHERE id='user1'; 
 
 
-- 패스워드 변경
UPDATE member
SET passwd='1234'
WHERE id='';
 
 
-- 회원 정보 수정 
UPDATE member  
SET passwd='TEST',
tel='123-123', 
email='email10',
zipcode='TEST',  
    address1='수원', 
    address2='팔달구', 
    job='TEST'
WHERE id = 'user3'; 
 
 
-- 'user3' 회원 삭제 
DELETE FROM member WHERE id='user3';
 
 
-- 로그인 관련 SQL 
SELECT COUNT(id) as cnt 
FROM member 
WHERE id = 'user1' AND passwd = '1234';  
 
 
 
-- list
 
SELECT id, mname, tel, email, zipcode, address1, 
address2, fname
FROM member
where mname like '%홍%'
ORDER BY mdate DESC 
limit 0,3;
```



C:\aistudy\spring\workspace\shopping\src\main\webapp\WEB-INF\sql 경로에 저장.

![image](https://user-images.githubusercontent.com/101780699/173980390-22f2c686-3d5e-4af9-a975-fa4f612f2a2d.png)



### 3. MemberDTO 구현

member 패키지 생성 후

MemberDTO.java 생성

```java
package com.study.member;

import org.springframework.web.multipart.MultipartFile;

import lombok.Data;

@Data
public class MemberDTO {
    private String id       ; 
    private String passwd   ;
    private String mname    ;
    private String tel      ;
    private String email    ;
    private String zipcode  ;
    private String address1 ;
    private String address2 ;
    private String job      ;
    private String mdate    ;
    private String fname    ;
    private String grade    ;
    private MultipartFile fnameMF;
                           
    
}
```



lombok으로 확인한 모습

![image](https://user-images.githubusercontent.com/101780699/173989422-fab9c5ca-c067-4c44-bf35-ddf09435da45.png)





---

---



 layout 설정 파일 생성
 \- /src/main/resources/templates/tiles_member.xml 

기존 tiles.xml -> tiles_member 이름 변경

![image](https://user-images.githubusercontent.com/101780699/173989698-f1e5e009-aaac-4bb4-b1f5-685f73717e76.png)

TilesConfiguration.java 수정 tiles.xml -> tiles_member경로 수정

```java
package com.study.shop;
 
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.view.tiles3.TilesConfigurer;
import org.springframework.web.servlet.view.tiles3.TilesView;
import org.springframework.web.servlet.view.tiles3.TilesViewResolver;
 
@Configuration
public class TilesConfiguration {
  @Bean
  public TilesConfigurer tilesConfigurer() {
      final TilesConfigurer configurer = new TilesConfigurer();
      //해당 경로에 tiles.xml 파일을 넣음
      configurer.setDefinitions(new String[]{"classpath:/templates/tiles_member.xml"});
      configurer.setCheckRefresh(true);
      return configurer;
  }
 
  @Bean
  public TilesViewResolver tilesViewResolver() {
      final TilesViewResolver tilesViewResolver = new TilesViewResolver();
      tilesViewResolver.setViewClass(TilesView.class);
      return tilesViewResolver;
  }
}

```



template/top.jsp 수정

```jsp
<%@ page contentType="text/html; charset=UTF-8" %> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<c:set var="root" value="${pageContext.request.contextPath }"/>
 <c:choose>
    <c:when test="${not empty sessionScope.id && sessionScope.grade == 'A'}">
        <c:set var="str">관리자 페이지 입니다.</c:set>
    </c:when>
    <c:when test="${not empty sessionScope.id && sessionScope.grade != 'A'}">
        <c:set var='str'>안녕하세요  ${sessionScope.id } 님!</c:set>
    </c:when>
    <c:otherwise>
        <c:set var="str">기본 페이지 입니다.</c:set>
    </c:otherwise>
</c:choose>
<!DOCTYPE html> 
<html> 
<head>
  <title>memo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <style type="text/css">
  #grade{
  
   color :white;
  }  
  </style>
</head>
<body> 
<!--상단메뉴-->
<div class="container-fluid">
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="${root}/">Shop</a>
    </div>
    <ul class="nav navbar-nav">
      <li class="active"><a href="${root}/">Home</a></li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Product
        <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="#">Jean</a></li>
          <li><a href="#">Bag</a></li>
          <li><a href="#">Shoes</a></li>
        </ul>
      </li>
            <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">community
        <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="${root}/contents/mypage">Mypage</a></li>
          <li><a href="${root}/contents/detail">Review</a></li>
          <li><a href="/notice/list">Notice</a></li>
          <li><a href="#">Q&A</a></li>
        </ul>
      </li>
    <li><a id="grade"><span class="glyphicon glyphicon-grain"></span> ${str}</a></li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
     <c:choose>
    <c:when test="${empty sessionScope.id }">
      <li><a href="${root}/member/agree"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
      <li><a href="${root}/member/login"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
          </c:when>
              <c:when test="${not empty sessionScope.id && sessionScope.grade == 'A'}">
    <li><a href="${root}/admin/contents/create"><span class="glyphicon glyphicon-plus-sign"></span> 상품등록</a></li>
    <li><a href="${root}/admin/member/list"><span class="glyphicon glyphicon-list"></span> 회원목록</a></li>
    <li><a href="${root}/member/logout"><span class="glyphicon glyphicon-log-out"></span> 로그아웃</a></li>
    </c:when>
    <c:otherwise>
    <li><a href="${root}/cart/list"><span class="glyphicon glyphicon-shopping-cart"></span> Cart</a></li>
    <li><a href="${root}/member/update"><span class="glyphicon glyphicon-edit"></span> 회원수정</a></li>
    <li><a href="${root}/member/logout"><span class="glyphicon glyphicon-log-out"></span> 로그아웃</a></li>
        </c:otherwise>
    </c:choose> 
    
    </ul>
  </div>
</nav>
 
</div>
</body>
</html>
```



(2) Controller, View 

member패키지

MemberController.java 생성

```java
package com.study.member;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class MemberController {

  @GetMapping()
  public String home() {
   return "/home"; 
  }
}

```

index.jsp 수정

```jsp
<%@ page contentType="text/html; charset=UTF-8" %> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
 
<!DOCTYPE html> 
<html> 
<head>
  <title>기본페이지</title>
  <meta charset="utf-8">
<style type="text/css">
    
img {
  display:inline;
 
}
 
</style>
</head>
<body> 
 
<div class="container">
    <p><a href="/content/list" >SHOP NOW</a></p>
    <img src="/images/jeans.jpg" alt="Jeans">
    
</div>
</body> 
</html>
```

![image](https://user-images.githubusercontent.com/101780699/174005483-713e89a0-d367-47ea-8a94-ac4c7d049532.png)





---

---



## [01] mybatis 설정, mybatis.xml, Mapper, @Service, @Controller, tiles

### 1. mybatis 설정

```sql
use webtest;

CREATE TABLE IF NOT EXISTS `webtest`.`member` (
  `id` VARCHAR(10) NOT NULL,
  `passwd` VARCHAR(20) NOT NULL,
  `mname` VARCHAR(20)  NOT NULL,
  `tel` VARCHAR(14) NULL,
  `email` VARCHAR(50) NOT NULL,
  `zipcode` VARCHAR(7) NULL,
  `address1` VARCHAR(150) NULL,
  `address2` VARCHAR(50) NULL,
  `job` VARCHAR(20) NOT NULL,
  `mdate` DATE NOT NULL,
  `fname` VARCHAR(50) NOT NULL DEFAULT 'member.jpg',
  `grade` VARCHAR(1) NOT NULL DEFAULT 'H',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `email_UNIQUE` (`email` ASC) VISIBLE)
ENGINE = InnoDB;

-- create 
INSERT INTO member(id, passwd, mname, tel, email, zipcode,  
address1,address2, job, mdate, fname, grade) 
VALUES('user1', '1234', '개발자1', '123-1234', 'email1@mail.com',  
'123-123','인천시', '남동구' ,'A01', sysdate(), 'member.jpg', 'H'); 
 
INSERT INTO member(id, passwd, mname, tel, email, zipcode,  
address1,address2, job, mdate, fname, grade) 
VALUES('user2', '1234', '개발자2', '123-1234', 'email2@mail.com',  
'123-123','광명시','남동구' ,'A01', sysdate(), 'member.jpg', 'H'); 
 
INSERT INTO member(id, passwd, mname, tel, email, zipcode,  
address1,address2, job, mdate, fname, grade) 
VALUES('user3', '1234', '개발자3', '123-1234', 'email3@mail.com',  
'123-123','용인시','남동구' ,'A01', sysdate(), 'member.jpg', 'H'); 

-- 관리자 계정
INSERT INTO member(id, passwd, mname, tel, email, zipcode,  
address1,address2, job, mdate, fname, grade) 
VALUES('admin', '1234', '관리자', '02-1234-1234', 'admin@mail.com',  
'123-123','서울시 서초구','남부터미널' ,'A01', sysdate(), 'member.jpg', 'A');  

select * from member;
```



![image](https://user-images.githubusercontent.com/101780699/173991914-eeecdd27-d19c-4dc6-801c-ff090fbed8da.png)



### 2. mybatis xml, Mappper Interface

mybaits/member.xml 생성

```xml
<?xml version="1.0" encoding="UTF-8" ?> 
 
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.study.member.MemberMapper">
	<select id="total" parameterType="Map" resultType="int">
		select count(*) from member
		<where>
			<choose>
				<when test="col=='mname'">
					mname concat('%', #{word} ,'%')
				</when>
				<when test="col=='id'">
					id like concat('%', #{word} ,'%')
				</when>
				<when test="col=='email'">
					email like concat('%', #{word} ,'%')
				</when>
			</choose>
		</where>
	</select>
	<select id="list" parameterType="Map"
		resultType="com.study.member.MemberDTO">
		SELECT id, mname, tel, email, zipcode, address1,
		address2, fname
		FROM member
		<where>
			<choose>
				<when test="col=='mname'">
					mname like concat('%', #{word} ,'%')
				</when>
				<when test="col=='id'">
					id like concat('%', #{word} ,'%')
				</when>
				<when test="col=='email'">
					email like concat('%', #{word} ,'%')
				</when>
			</choose>
		</where>
		ORDER BY mdate DESC
		limit #{sno}, #{eno}

	</select>

	<update id="updateFile" parameterType="Map">
		update member
		set fname = #{fname}
		where id = #{id}
	</update>
	<update id="update" parameterType="com.study.member.MemberDTO">
		update member
		set tel = #{tel},
		email = #{email},
		zipcode = #{zipcode},
		address1 = #{address1},
		address2 = #{address2},
		job = #{job}
		where id = #{id}
	</update>

	<select id="read" parameterType="String"
		resultType="com.study.member.MemberDTO">
		select *
		from member
		where id = #{id}
	</select>

	<select id="getGrade" parameterType="String" resultType="Map">
		select grade, mname
		from member
		where id = #{id}
	</select>
	<select id="loginCheck" parameterType="Map" resultType="int">
		select
		count(*) from member
		where id = #{id}
		and passwd = #{passwd}
	</select>

	<select id="duplicatedId" parameterType="String"
		resultType="int">
		SELECT COUNT(id)
		FROM member
		WHERE id=#{id}
	</select>
	<select id="duplicatedEmail" parameterType="String"
		resultType="int">
		SELECT COUNT(email)
		FROM member
		WHERE email=#{email}
	</select>

	<insert id="create" parameterType="com.study.member.MemberDTO">
		INSERT INTO member(id, passwd, mname, tel, email, zipcode,
		address1, address2, job, mdate, fname, grade)
		VALUES(#{id}, #{passwd},#{mname}, #{tel}, #{email}, #{zipcode},
		#{address1}, #{address2}, #{job}, sysdate(), #{fname}, 'H')
	</insert>

</mapper>
```

MemberMapper.java  인터페이스 생성

```java
package com.study.member;
 
import java.util.List;
import java.util.Map;
 
public interface MemberMapper {
 
        int duplicatedId(String id);
 
        int duplicatedEmail(String email);
 
        int create(MemberDTO dto);
 
        int loginCheck(Map<String, String> map);
 
        Map getGrade(String id);
 
        MemberDTO read(String id);
 
        int update(MemberDTO dto);
 
        int total(Map map);
 
        List<MemberDTO> list(Map map);
 
        int updateFile(Map map);
 
}
```



### 3. Service Interface, impl Class 구현

MemberService.java 생성

```java
package com.study.member;
 
import java.util.List;
import java.util.Map;
 
public interface MemberService {
        int duplicatedId(String id);
 
        int duplicatedEmail(String email);
 
        int create(MemberDTO dto);
 
        int loginCheck(Map<String, String> map);
 
        Map getGrade(String id);
 
        MemberDTO read(String id);
 
        int update(MemberDTO dto);
 
        int total(Map map);
 
        List<MemberDTO> list(Map map);
 
        int updateFile(Map map);
 
}
```

MemberServiceImpl.java 생성

```java
package com.study.member;
 
import java.util.List;
import java.util.Map;
 
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
 
@Service("com.study.member.MemberServiceImpl")
public class MemberServiceImpl implements MemberService {
        
  @Autowired
  private MemberMapper mapper;
 
        @Override
        public int duplicatedId(String id) {
                // TODO Auto-generated method stub
                return mapper.duplicatedId(id);
        }
 
        @Override
        public int duplicatedEmail(String email) {
                // TODO Auto-generated method stub
                return mapper.duplicatedEmail(email);
        }
 
        @Override
        public int create(MemberDTO dto) {
                // TODO Auto-generated method stub
                return mapper.create(dto);
        }
 
        @Override
        public int loginCheck(Map<String, String> map) {
                // TODO Auto-generated method stub
                return mapper.loginCheck(map);
        }
 
        @Override
        public Map getGrade(String id) {
                // TODO Auto-generated method stub
                return mapper.getGrade(id);
        }
 
        @Override
        public MemberDTO read(String id) {
                // TODO Auto-generated method stub
                return mapper.read(id);
        }
 
        @Override
        public int update(MemberDTO dto) {
                // TODO Auto-generated method stub
                return mapper.update(dto);
        }
 
        @Override
        public int total(Map map) {
                // TODO Auto-generated method stub
                return mapper.total(map);
        }
 
        @Override
        public List<MemberDTO> list(Map map) {
                // TODO Auto-generated method stub
                return mapper.list(map);
        }
 
        @Override
        public int updateFile(Map map) {
                // TODO Auto-generated method stub
                return mapper.updateFile(map);
        }
 
}
```



### 4. Controller Class 작성

MemberController.java 수정

```java
package com.study.member;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class MemberController {

  @GetMapping()
  public String home() {
   return "/home"; 
  }
}

```

### 5. 업로드 파일 경로, View 페이지에서 이미지 보이도록 함

(1) 파일 업로드 경로

 \- 경로 마지막에 / 꼭 닫기

![image](https://user-images.githubusercontent.com/101780699/173994338-7ce36bbb-9314-4e4e-a9ef-50c1b94800af.png)



com.study.member.UploadMem.java 생성

```java
package com.study.member;
import java.io.File;
 
public class UploadMem {
    /** 페이지당 출력할 레코드 갯수 */
    public static int RECORD_PER_PAGE = 3;
 
    // Windows, VMWare, AWS cloud 절대 경로 설정
    public static synchronized String getUploadDir() {
        String path = "";
        if (File.separator.equals("\\")) {
            path = "C:/aistudy/deploy/member/storage/";
            System.out.println("Windows 10: " + path);
            
        } else {
            // System.out.println("Linux");
            path = "/home/ubuntu/deploy/bbs/storage/";
        }
        
        return path;
    }
    
}
```



(2) View 페이지에서 이미지 보이도록 함
 \- Spring Boot가 OS의 특정 폴더에 접근 가능하도록 설정
  \- list, read view 페이지 에서 볼수 없음: 보안 문제로 인하여 이미지에 접근 할 수 없음

com.study.shop/WebMvcConfiguration.java 생성

```java
package com.study.shop;
 
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;
//import com.study.contents.*;
import com.study.member.*;
 
@Configuration
public class WebMvcConfiguration implements WebMvcConfigurer {
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        // Windows: path = "f:/AIstudy/deploy/shopping/contents/storage";
        // ▶ file:///f:/AIstudy/deploy/shopping/contents/storage
        // Ubuntu: path = "/home/ubuntu/deploy/shopping/contents/storage";
        // ▶ file:////home/ubuntu/deploy/shopping/contents/storage
        // JSP 인식되는 경로: http://localhost:8000/contents/storage";
        //registry.addResourceHandler("/contents/storage/**").addResourceLocations("file:///" + UploadCon.getUploadDir());
        // registry.addResourceHandler("/attachfile/storage/**").addResourceLocations("file:///" + Attachfile.getUploadDir());
        registry.addResourceHandler("/member/storage/**")
                 .addResourceLocations("file:///" + UploadMem.getUploadDir());
    }
 
}
```



### 6. 유틸 클래스 작성

utility 패키지 생성 후 com.study.utility.Utility.java 붙여넣기

```java
package com.study.utility;

import java.io.File;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.OutputStream;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.web.multipart.MultipartFile;


public class Utility {
  
  /**
   * 오늘,어제,그제 날짜 가져오기
   * 
   * @return List- 날짜들 저장 SimpleDateFormat("yyyy-MM-dd")
   */
  public static List<String> getDay() {
    List<String> list = new ArrayList<String>();

    SimpleDateFormat sd = new SimpleDateFormat("yyyy-MM-dd");
    Calendar cal = Calendar.getInstance();
    for (int j = 0; j < 3; j++) {
      list.add(sd.format(cal.getTime()));
      cal.add(Calendar.DATE, -1);
    }

    return list;
  }

  /**
   * 등록날짜와 오늘,어제,그제날짜와 비교
   * 
   * @param wdate - 등록날짜
   * @return - true:오늘,어제,그제중 등록날짜와 같음 false:오늘,어제,그제 날짜가 등록날짜와 다 다름
   */
  public static boolean compareDay(String wdate) {
    boolean flag = false;
    List<String> list = getDay();
    if (wdate.equals(list.get(0)) || wdate.equals(list.get(1)) || wdate.equals(list.get(2))) {
      flag = true;
    }

    return flag;
  }

  public static String checkNull(String str) {
    if (str == null) {
      str = "";
    }
    return str;
  }

  /**
   * @param totalRecord   전체 레코드수
   * @param nowPage       현재 페이지
   * @param recordPerPage 페이지당 레코드 수
   * @param col           검색 컬럼
   * @param word          검색어
   * @return 페이징 생성 문자열
   */
  public static String paging(int totalRecord, int nowPage, int recordPerPage, String col, String word) {
    int pagePerBlock = 5; // 블럭당 페이지 수
    int totalPage = (int) (Math.ceil((double) totalRecord / recordPerPage)); // 전체 페이지
    int totalGrp = (int) (Math.ceil((double) totalPage / pagePerBlock));// 전체 그룹
    int nowGrp = (int) (Math.ceil((double) nowPage / pagePerBlock)); // 현재 그룹
    int startPage = ((nowGrp - 1) * pagePerBlock) + 1; // 특정 그룹의 페이지 목록 시작
    int endPage = (nowGrp * pagePerBlock); // 특정 그룹의 페이지 목록 종료

    StringBuffer str = new StringBuffer();
    str.append("<div style='text-align:center'>");
    str.append("<ul class='pagination'> ");
    int _nowPage = (nowGrp - 1) * pagePerBlock; // 10개 이전 페이지로 이동
    if (nowGrp >= 2) {
      str.append("<li><a href='./list?col=" + col + "&word=" + word + "&nowPage=" + _nowPage + "'>이전</A></li>");
    }

    for (int i = startPage; i <= endPage; i++) {
      if (i > totalPage) {
        break;
      }

      if (nowPage == i) {
        str.append("<li class='active'><a href=#>" + i + "</a></li>");
      } else {
        str.append("<li><a href='./list?col=" + col + "&word=" + word + "&nowPage=" + i + "'>" + i + "</A></li>");
      }
    }

    _nowPage = (nowGrp * pagePerBlock) + 1; // 10개 다음 페이지로 이동
    if (nowGrp < totalGrp) {
      str.append("<li><A href='./list?col=" + col + "&word=" + word + "&nowPage=" + _nowPage + "'>다음</A></li>");
    }
    str.append("</ul>");
    str.append("</div>");

    return str.toString();
  }

  public static String saveFileSpring(MultipartFile mf, String basePath) {
    InputStream inputStream = null;
    OutputStream outputStream = null;
    String filename = "";
    long filesize = mf.getSize();
    String originalFilename = mf.getOriginalFilename();
    try {
      if (filesize > 0) { // 파일이 존재한다면
        // 인풋 스트림을 얻는다.
        inputStream = mf.getInputStream();

        File oldfile = new File(basePath, originalFilename);

        if (oldfile.exists()) {
          for (int k = 0; true; k++) {
            // 파일명 중복을 피하기 위한 일련 번호를 생성하여
            // 파일명으로 조합
            oldfile = new File(basePath, "(" + k + ")" + originalFilename);

            // 조합된 파일명이 존재하지 않는다면, 일련번호가
            // 붙은 파일명 다시 생성
            if (!oldfile.exists()) { // 존재하지 않는 경우
              filename = "(" + k + ")" + originalFilename;
              break;
            }
          }
        } else {
          filename = originalFilename;
        }
        String os = System.getProperty("os.name").toLowerCase();
        System.out.println("os: " + os); // windows 10, linux, mac os x
        String serverFullPath = null;
        if (os.equals("mac os x")) { // Mac
          System.out.println("맥");
          serverFullPath = basePath + "/" + filename;
        } else if (os.equals("windows 10")) {
          System.out.println("os: " + os);
          serverFullPath = basePath + "\\" + filename;
        } else if (os.equals("linux")) {
          System.out.println("리눅스");
          serverFullPath = basePath + "/" + filename;
        }

        System.out.println("fileName: " + filename);
        System.out.println("serverFullPath: " + serverFullPath);

        outputStream = new FileOutputStream(serverFullPath);

        // 버퍼를 만든다.
        int readBytes = 0;
        byte[] buffer = new byte[8192];

        while ((readBytes = inputStream.read(buffer, 0, 8192)) != -1) {
          outputStream.write(buffer, 0, readBytes);
        }
        outputStream.close();
        inputStream.close();

      }

    } catch (Exception e) {
      e.printStackTrace();
    } finally {

    }

    return filename;
  }

  public static void deleteFile(String upDir, String oldfile) {
    File file = new File(upDir, oldfile);
    if (file.exists())
      file.delete();

  }
  
  public static String rpaging(int total, int nowPage, int recordPerPage, String col, String word, String url,
      int nPage) {
    int pagePerBlock = 5; // 블럭당 페이지 수
    int totalPage = (int) (Math.ceil((double) total / recordPerPage)); // 전체 페이지
    int totalGrp = (int) (Math.ceil((double) totalPage / pagePerBlock));// 전체 그룹
    int nowGrp = (int) (Math.ceil((double) nPage / pagePerBlock)); // 현재 그룹
    int startPage = ((nowGrp - 1) * pagePerBlock) + 1; // 특정 그룹의 페이지 목록 시작
    int endPage = (nowGrp * pagePerBlock); // 특정 그룹의 페이지 목록 종료
 
    StringBuffer str = new StringBuffer();
    str.append("<div style='text-align:center'>");
    str.append("<ul class='pagination'> ");
    int _nowPage = (nowGrp - 1) * pagePerBlock; // 10개 이전 페이지로 이동
 
    if (nowGrp >= 2) {
      str.append("<li><a href='" + url + "?col=" + col + "&word=" + word + "&nowPage=" + nowPage 
          + "&nPage=" + _nowPage + "'>이전</A></li>");
    }
 
    for (int i = startPage; i <= endPage; i++) {
      if (i > totalPage) {
        break;
      }
 
      if (nPage == i) {
        str.append("<li class='active'><a href=#>" + i + "</a></li>");
      } else {
        str.append("<li><a href='" + url + "?col=" + col + "&word=" + word + "&nowPage=" + nowPage 
            + "&nPage=" + i + "'>" + i + "</A></li>");
      }
    }
 
    _nowPage = (nowGrp * pagePerBlock) + 1; // 10개 다음 페이지로 이동
    if (nowGrp < totalGrp) {
      str.append("<li><A href='" + url + "?col=" + col + "&word=" + word + "&nowPage=" + nowPage 
          + "&nPage=" + _nowPage + "'>다음</A></li>");
    }
    str.append("</ul>");
    str.append("</div>");
 
    return str.toString();
 
  }
//  public static int rcount(int bbsno,ReplyService rservice){
//    return rservice.total(bbsno);
//  }
  public static String getCodeValue(String code) {
    String jobname = null;
    Map<String,String> codes = new HashMap<String,String>();
    
    codes.put("A01", "회사원");
    codes.put("A02", "전산관련직");
    codes.put("A03", "연구전문직");
    codes.put("A04", "각종학교학생");
    codes.put("A05", "일반자영업");
    codes.put("A06", "공무원");
    codes.put("A07", "의료인");
    codes.put("A08", "법조인");
    codes.put("A09", "종교/언론/예술인");
    codes.put("A10", "기타");
    
    jobname = codes.get(code);
    return jobname;
    
}
}

```



### 6. View 페이지와 Tiles 
\- views/member 폴더를 다운받은 후 위치에 복사한다.

\>>> tiles_member.xml 수정

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE tiles-definitions PUBLIC
       "-//Apache Software Foundation//DTD Tiles Configuration 3.0//EN"
       "http://tiles.apache.org/dtds/tiles-config_3_0.dtd">
 
<tiles-definitions>
  <!-- main -->
  <definition name="main"
    template="/WEB-INF/views/template/template.jsp">
    <put-attribute name="header"
      value="/WEB-INF/views/template/top.jsp" />
  </definition>
  <definition name="/home" extends="main">
    <put-attribute name="title" value="기본페이지"></put-attribute>
    <put-attribute name="body"
      value="/WEB-INF/views/index.jsp" />
  </definition>
  <definition name="/member/agree" extends="main"> 
            <put-attribute name="title" value="약관동의" ></put-attribute> 
            <put-attribute name="body" value="/WEB-INF/views/member/agreement.jsp" /> 
    </definition>   
    <definition name="/member/create" extends="main"> 
            <put-attribute name="title" value="회원가입" ></put-attribute> 
            <put-attribute name="body" value="/WEB-INF/views/member/createForm.jsp" /> 
    </definition>   
    <definition name="/member/login" extends="main"> 
            <put-attribute name="title" value="로그인" ></put-attribute> 
            <put-attribute name="body" value="/WEB-INF/views/member/loginForm.jsp" /> 
    </definition>   
    <definition name="/member/read" extends="main"> 
            <put-attribute name="title" value="나의정보" ></put-attribute> 
            <put-attribute name="body" value="/WEB-INF/views/member/read.jsp" /> 
    </definition>   
    <definition name="/member/update" extends="main"> 
            <put-attribute name="title" value="정보수정" ></put-attribute> 
            <put-attribute name="body" value="/WEB-INF/views/member/updateForm.jsp" /> 
    </definition>   
    <definition name="/member/list" extends="main"> 
            <put-attribute name="title" value="회원목록" ></put-attribute> 
            <put-attribute name="body" value="/WEB-INF/views/member/list.jsp" /> 
    </definition>   
    <definition name="/member/updateFile" extends="main"> 
            <put-attribute name="title" value="사진수정" ></put-attribute> 
            <put-attribute name="body" value="/WEB-INF/views/member/updateFileForm.jsp" /> 
    </definition> 
</tiles-definitions>
```

![image](https://user-images.githubusercontent.com/101780699/173997145-6ac084bf-2cbf-44b8-b9a9-e29e05c5a96c.png)

![image](https://user-images.githubusercontent.com/101780699/173997537-20528b0c-01ce-448e-ab58-7e5d53ec1623.png)



---



```java
package com.study.member;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;

@Controller
public class MemberController {

  @Autowired
  @Qualifier("com.study.member.MemberServiceImpl")
  private MemberService service;
  
  @GetMapping("/")
  public String home() {

          return "/home";
  }

  @GetMapping("/member/agree")
  public String agree() {

    return "/member/agree";
  }

  @PostMapping("/member/createForm")
  public String create() {
    return "/member/create";
  }

}

```



![image](https://user-images.githubusercontent.com/101780699/173998129-0f2748dd-de3d-4235-8a3f-758f74057cec.png)

![image](https://user-images.githubusercontent.com/101780699/173998364-1b72f90e-dc87-46b7-83f2-94ce747498b1.png)

---



MemberController.java 수정

```java
  @GetMapping(value = "/member/emailcheck", produces = "application/json;charset=utf-8")
  @ResponseBody
  public Map<String, String> emailcheck(String email) {
    int cnt = service.duplicatedEmail(email);

    Map<String, String> map = new HashMap<String, String>();
    if (cnt > 0) {
      map.put("str", email + "는 중복되어서 사용할 수 없습니다.");
    } else {
      map.put("str", email + "는 중복아님, 사용가능합니다.");
    }
    return map;
  }

  @GetMapping(value = "/member/idcheck", produces = "application/json;charset=utf-8")
  @ResponseBody
  public Map<String, String> idcheck(String id) {
    int cnt = service.duplicatedId(id);

    Map<String, String> map = new HashMap<String, String>();
    if (cnt > 0) {
      map.put("str", id + "는 중복되어서 사용할 수 없습니다.");
    } else {
      map.put("str", id + "는 중복아님, 사용가능합니다.");
    }
    return map;
  }
```



![image](https://user-images.githubusercontent.com/101780699/173999069-2f79f418-5ba9-4e1c-9ab4-3d48ccc760d3.png)

![image](https://user-images.githubusercontent.com/101780699/173999098-91d19e8b-266c-4469-9a86-c0feed2d06fa.png)



---



MemberController.java 수정 create 추가

```java
  @PostMapping("/member/create")
  public String create(MemberDTO dto, HttpServletRequest request) throws IOException {
    String upDir = UploadMem.getUploadDir();
    String fname = Utility.saveFileSpring(dto.getFnameMF(), upDir);
    int size = (int) dto.getFnameMF().getSize();
    if (size > 0) {
      dto.setFname(fname);
    } else {
      dto.setFname("member.jpg");
    }

    if (service.create(dto) > 0) {
      return "redirect:/";
    } else {
      return "error";
    }
  }
```

![image](https://user-images.githubusercontent.com/101780699/174000018-91c2bd69-693f-4109-a8ec-e8c1dfe702f2.png)

Mysql에서 확인가능

![image](https://user-images.githubusercontent.com/101780699/174000067-4ea8c659-9357-4b90-ae6c-0640d7031136.png)



---



MemberController.java 수정 login logout 추가

```java
 @GetMapping("/member/logout")
        public String logout(HttpSession session) {
                //session.removeAttribute("id");
                //session.removeAttribute("grade");
                session.invalidate();
                
                return "redirect:/";
        }
        
        @PostMapping("/member/login")
        public String login(@RequestParam Map<String,String> map,
                        HttpSession session,
                        HttpServletResponse response,
                        HttpServletRequest request,
                        Model model) {
                int cnt = service.loginCheck(map);
                
                if(cnt > 0) {//회원이다.
                        Map gmap = service.getGrade(map.get("id"));
                        session.setAttribute("id", map.get("id"));
                        session.setAttribute("grade", gmap.get("grade"));
                        session.setAttribute("mname", gmap.get("mname"));
 
                        //Cookie 저장,id저장 여부 및 id
                        Cookie cookie = null;
                        String c_id = request.getParameter("c_id");
                        if(c_id != null) {
                                cookie = new Cookie("c_id",c_id ); //c_id=> Y
                                cookie.setMaxAge(60 * 60 * 24 * 365);//1년
                                response.addCookie(cookie);//요청지(client:브라우저 컴) 쿠키 저장
                                
                                cookie = new Cookie("c_id_val",map.get("id"));
                                cookie.setMaxAge(60 * 60 * 24 * 365);//1년
                                response.addCookie(cookie);//요청지(client:브라우저 컴) 쿠키 저장
                        }else {
                                cookie = new Cookie("c_id",""); //쿠키 삭제
                                cookie.setMaxAge(0);
                                response.addCookie(cookie);
                                
                                cookie = new Cookie("c_id_val","");//쿠키 삭제
                                cookie.setMaxAge(0);
                                response.addCookie(cookie);             
                                
                        }
                        
                }//ifcnt>0 end
                        
                if(cnt>0) {
                        
                        if(map.get("rurl") != null && !map.get("rurl").equals("")) {
                                model.addAttribute("bbsno", map.get("bbsno"));
                                model.addAttribute("nPage", map.get("nPage"));
                                model.addAttribute("nowPage", map.get("nowPage"));
                                model.addAttribute("col", map.get("col"));
                                model.addAttribute("word", map.get("word"));
                                                        
                                return "redirect:" + map.get("rurl");
                        }else {
                        
                                return "redirect:/";
                        }
                        
                }else {
                        model.addAttribute("msg","아이디 또는 비밀번호를 잘못 입력 했거나 <br>회원이 아닙니다. 회원가입 하세요");
                        return "/member/errorMsg";
                }
        }
        
        @GetMapping("/member/login")
        public String login(HttpServletRequest request) {
                /*----쿠키설정 내용시작----------------------------*/
                String c_id = "";     // ID 저장 여부를 저장하는 변수, Y
                String c_id_val = ""; // ID 값
                 
                Cookie[] cookies = request.getCookies(); 
                Cookie cookie=null; 
                 
                if (cookies != null){ 
                 for (int i = 0; i < cookies.length; i++) { 
                   cookie = cookies[i]; 
                 
                   if (cookie.getName().equals("c_id")){ 
                     c_id = cookie.getValue();     // Y 
                   }else if(cookie.getName().equals("c_id_val")){ 
                     c_id_val = cookie.getValue(); // user1... 
                   } 
                 } 
                } 
                /*----쿠키설정 내용 끝----------------------------*/
                
                request.setAttribute("c_id", c_id);
                request.setAttribute("c_id_val", c_id_val);
                
                return "/member/login";
        }
```

![image](https://user-images.githubusercontent.com/101780699/174000886-6da9b68b-838f-436e-9c83-355096f1d368.png)

![image](https://user-images.githubusercontent.com/101780699/174001663-a809fe0d-e288-4a70-9de0-b65d7171bbfd.png)

![image](https://user-images.githubusercontent.com/101780699/174005414-b5ea5e8f-360b-4ced-8796-91c553779110.png)



---



top.jsp 수정  관리자 페이지의 주문목록 추가

```jsp
<%@ page contentType="text/html; charset=UTF-8" %> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<c:set var="root" value="${pageContext.request.contextPath }"/>
 <c:choose>
    <c:when test="${not empty sessionScope.id && sessionScope.grade == 'A'}">
        <c:set var="str">관리자 페이지 입니다.</c:set>
    </c:when>
    <c:when test="${not empty sessionScope.id && sessionScope.grade != 'A'}">
        <c:set var='str'>안녕하세요  ${sessionScope.id } 님!</c:set>
    </c:when>
    <c:otherwise>
        <c:set var="str">기본 페이지 입니다.</c:set>
    </c:otherwise>
</c:choose>
<!DOCTYPE html> 
<html> 
<head>
  <title>memo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <style type="text/css">
  #grade{
  
   color :white;
  }  
  </style>
</head>
<body> 
<!--상단메뉴-->
<div class="container-fluid">
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="${root}/">Shop</a>
    </div>
    <ul class="nav navbar-nav">
      <li class="active"><a href="${root}/">Home</a></li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Product
        <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="#">Jean</a></li>
          <li><a href="#">Bag</a></li>
          <li><a href="#">Shoes</a></li>
        </ul>
      </li>
            <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">community
        <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="${root}/contents/mypage">Mypage</a></li>
          <li><a href="${root}/contents/detail">Review</a></li>
          <li><a href="/notice/list">Notice</a></li>
          <li><a href="#">Q&A</a></li>
        </ul>
      </li>
    <li><a id="grade"><span class="glyphicon glyphicon-grain"></span> ${str}</a></li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
     <c:choose>
    <c:when test="${empty sessionScope.id }">
      <li><a href="${root}/member/agree"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
      <li><a href="${root}/member/login"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
          </c:when>
              <c:when test="${not empty sessionScope.id && sessionScope.grade == 'A'}">
    <li><a href="${root}/admin/contents/create"><span class="glyphicon glyphicon-plus-sign"></span> 상품등록</a></li>
    <li><a href="${root}/admin/member/list"><span class="glyphicon glyphicon-list"></span> 회원목록</a></li>
    <li><a href="${root}/admin/order/list"><span class="glyphicon glyphicon-list"></span> 주문목록</a></li>
    <li><a href="${root}/member/logout"><span class="glyphicon glyphicon-log-out"></span> 로그아웃</a></li>
    </c:when>
    <c:otherwise>
    <li><a href="${root}/cart/list"><span class="glyphicon glyphicon-shopping-cart"></span> Cart</a></li>
    <li><a href="${root}/member/update"><span class="glyphicon glyphicon-edit"></span> 회원수정</a></li>
    <li><a href="${root}/member/logout"><span class="glyphicon glyphicon-log-out"></span> 로그아웃</a></li>
        </c:otherwise>
    </c:choose> 
    
    </ul>
  </div>
</nav>
 
</div>
</body>
</html>
```

![image](https://user-images.githubusercontent.com/101780699/174007269-e3d95f2e-c8e3-4aca-b362-e65eecc9c550.png)



---



MemberController.java 수정 update, updateFile 추가

```java
  @PostMapping("/member/update")
  public String update(MemberDTO dto, Model model) {
    int cnt = service.update(dto);

    if (cnt == 1) {
      model.addAttribute("id", dto.getId());
      return "redirect:/";
    } else {
      return "error";
    }
  }

  @GetMapping("/member/update")
  public String update(String id, HttpSession session, Model model) {

    if (id == null) {
      id = (String) session.getAttribute("id");
    }

    MemberDTO dto = service.read(id);

    model.addAttribute("dto", dto);

    return "/member/update";

  }

@PostMapping("/member/updateFile")
  public String updateFile(MultipartFile fnameMF, String oldfile, HttpSession session, HttpServletRequest request)
      throws IOException {
    String basePath = UploadMem.getUploadDir();

    if (oldfile != null && !oldfile.equals("member.jpg")) { // 원본파일 삭제
      Utility.deleteFile(basePath, oldfile);
    }

    // storage에 변경 파일 저장
    Map map = new HashMap();
    map.put("id", session.getAttribute("id"));
    map.put("fname", Utility.saveFileSpring(fnameMF, basePath));

    // 디비에 파일명 변경
    int cnt = service.updateFile(map);

    if (cnt == 1) {
      return "redirect:./";
    } else {
      return "./error";
    }
  }

  @GetMapping("/member/updateFile")
  public String updateFileForm() {

    return "/member/updateFile";
  }
```



![image](https://user-images.githubusercontent.com/101780699/174010461-d9d4bad1-b233-4774-9502-ae3b22f519b1.png)

![image](https://user-images.githubusercontent.com/101780699/174011122-d345777c-855e-4a6a-bc05-eda0b8b58f0d.png)





---



MemberController.java 수정 list 추가

```java
  @RequestMapping("/admin/member/list")
  public String list(HttpServletRequest request) {
    // 검색관련------------------------
    String col = Utility.checkNull(request.getParameter("col"));
    String word = Utility.checkNull(request.getParameter("word"));

    if (col.equals("total")) {
      word = "";
    }

    // 페이지관련-----------------------
    int nowPage = 1;// 현재 보고있는 페이지
    if (request.getParameter("nowPage") != null) {
      nowPage = Integer.parseInt(request.getParameter("nowPage"));
    }
    int recordPerPage = 3;// 한페이지당 보여줄 레코드갯수

    // DB에서 가져올 순번(mysql)-----------------
    int sno = (nowPage - 1) * recordPerPage;
    int eno = recordPerPage;

    Map map = new HashMap();
    map.put("col", col);
    map.put("word", word);
    map.put("sno", sno);
    map.put("eno", eno);

    int total = service.total(map);

    List<MemberDTO> list = service.list(map);

    String paging = Utility.paging(total, nowPage, recordPerPage, col, word);

    // request에 Model사용 결과 담는다
    request.setAttribute("list", list);
    request.setAttribute("nowPage", nowPage);
    request.setAttribute("col", col);
    request.setAttribute("word", word);
    request.setAttribute("paging", paging);

    return "/member/list";

  }
```



![image](https://user-images.githubusercontent.com/101780699/174022081-02ff31b5-f8a4-49dd-9e9b-105202b5d830.png)





---



## [01] 인테셉터 사용
\- 관리자 권한이 없는 상태에서 관리자만 접근할 수 있는 페이지를 불법으로 접근하면 관리자 로그인
 페이지로 이동하여 관리자 로그인을 유도한다.
\- 인테셉터 이용전 일반계정 user1은 권한이 부족하지만 관리자 페이지에 접근할 수 있다.
\- http://localhost:8000/admin/list

### 1 필터 

 \- web 개발에서 사용자의 권한을 확인하여 권한이 없는 경우에 권한을 획득할 수 있도록
  로그인 페이지로 이동시킨다.
 \- Filter는 요청과 응답을 필터링 후 정제하는 역할을 한다.
 \- Filter는 Front Controller 이전에 실행된다. 필터가 요청내용을 변경하거나, 여러가지 체크를
  수행할 수 있다.
 \- 요청의 처리가 끝난 후 응답내용에 대해서도 변경하는 처리를 할 수가 있다.
 \- 일반적으로 인코딩 변환 처리, 로그인 처리, 권한체크 등을 한다.

[ 필터의 실행메서드 ]

ㆍinit() - 필터 인스턴스 초기화
ㆍdoFilter() - 요청 작업 전/후 처리
ㆍdestroy() - 필터 인스턴스 종료

### 2 인터셉터 

 \- Spring MVC에서 Filter 대신 Intercepter를 이용할 수 있다.
 \- 요청에 대한 작업 전/후로 가로챈다고 보면 된다.
 \- 필터는 스프링 컨텍스트 외부에 존재하여 스프링과 무관한 자원에 대해 동작한다.(일반 JSP, MVC에서 가능) 
 \- 인터셉터는 스프링의 Front Controller가 요청처리(백앤드) 컨트롤러를 호출하기 전, 후로 끼어들기 때문에
  스프링 컨텍스트(Context, 영역) 내부에서 Controller에 관한 요청과 응답에 대해 처리한다.
 \- 스프링의 모든 빈 객체에 접근할 수 있다.
 \- 로그인 체크, 권한체크, 프로그램 실행시간 계산작업 로그확인 등의 업무처리 등을 할 수 있다.

[ 인터셉터의 실행메서드 ]

preHandler() - 컨트롤러 메서드가 실행되기 전
postHanler() - 컨트롤러 메서드 실행된 후 view페이지 렌더링 되기 전
afterCompletion() - view페이지가 렌더링 되고 난 후

### 3. Filter, Interceptor, AOP의 흐름

\- 공통업무에 관련된 코드를 모든 페이지 마다 작성 해야 한다면 중복된 코드가 많아지게 되고 
 프로젝트 단위가 커질수록 서버에 부하를 줄 수도있으며, 소스 관리도 되지 않는다.
\- 즉, 공통 부분은 빼서 따로 관리하는게 좋다.
\- 이러한 공통업무를 프로그램 흐름의 앞, 중간, 뒤에 추가하여 자동으로 처리 할 수 있다.
\- 공통처리를 위해 활용할 수 있는 것이 Filter, Intercepter, AOP이다.
\- 파란화살표 : Filter
\- 갈색화살표 : Intercepter
\- 붉은화살표 : AOP

### 4. HandlerIntercepter 인터페이스 구현 및 설정

\- shopping project의 관리자 인증에서 Interceptor를 사용한다.

 

shop패키지 AdminInterceptor.java 생성

```java
package com.study.shop;
 
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;
 
import com.study.utility.Utility;
 
public class AdminInterceptor extends HandlerInterceptorAdapter {
// URL 요청후 콘트롤러 작동전에 실행함.
  @Override
  public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
    HttpSession session = request.getSession(true);
// 회원 로그인시 "grade" 세션 변수 생성, "A" 할당
    String grade = Utility.checkNull((String) session.getAttribute("grade"));
    System.out.println("session.getAttribute(\"grade\"): " + grade);
    System.out.println("preHandle executed.");
    if (grade.length() != 0 && grade.compareTo("A") <= 0) { // 접근 가능, 요청 페이지 처리,회원이거나 회원보다 높은 권한
      System.out.println("접속 권한 있음: " + grade);
      return true; // 요청 페이지로 계속 진행
    } else {
// 에러 출력또는 로그인 페이지로 이동
      response.sendRedirect("/member/login");
      return false;
    }
  }
 
// 요청 주소 결과 생성후 작동함
  @Override
  public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler,
      ModelAndView modelAndView) throws Exception {
    System.out.println("postHandle executed.");
    modelAndView.addObject("admin", "관리자 관련 기능을 출력합니다.");
  }
 
// JSP등 View 페이지 출력전에 작동됨.
  @Override
  public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)
      throws Exception {
    System.out.println("관리자 Interceptor 실행 후 최종 출력됨.");
  }
}
```



(2) Interceptor 등록 설정

shop패키지  MVCConfiguration.java 생성

```java
package com.study.shop;
 
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;
 
@Configuration
public class MVCConfiguration implements WebMvcConfigurer {
  @Override
  public void addInterceptors(InterceptorRegistry registry) {
 
// URL에 "/admin/"이 들어간 요청은 AdminInterceptor 작동함.
    registry.addInterceptor(new AdminInterceptor()).addPathPatterns("/admin/**");
 
  }
}
```





---

---





## [01] Category 테이블 모델링

### 1. 순환관계 모델링 하기

 \- 순환관계를 정의할때는 반드시 비식별관계로 정의 해야 한다. 
 \- 최초로 입력되는 최상의 코드의 FK에는 NULL값이 들어간다.
 \- 자식 엔티티로 전이되는 포린키 컬럼의 이름을 바꿔준다.

![image](https://user-images.githubusercontent.com/101780699/174030774-ab34a128-de33-4fa9-8dcf-cd00eed0a077.png)

(2) Workbench contents 테이블에 컬럼 추가

```sql
use webtest;

CREATE TABLE IF NOT EXISTS `webtest`.`category` (
  `cateno` INT NOT NULL AUTO_INCREMENT, -- 분류번호
  `catename` VARCHAR(50) NOT NULL,      -- 분류명
  `categrpno` INT NULL, -- 상위번호
  PRIMARY KEY (`cateno`),
  FOREIGN KEY (`categrpno`) REFERENCES category(`cateno`)
);
 
insert into category(catename, categrpno)
values('Jean', null);
insert into category(catename, categrpno)
values('Bag', null);
insert into category(catename, categrpno)
values('Shoes', null);
        
select cateno, catename
from category
where categrpno is null;

```

